<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuest OS | Professional Learning Platform</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #0077cc; --secondary: #28a745; --ela: #6f42c1; --games: #fd7e14;
            --danger: #dc3545; --warning: #ffc107; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32;
            --background: #f0f4f8; --surface: #ffffff; --text: #333333; --text-light: #666666;
            --border: #dde1e6; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', sans-serif; }
        body { background-color: var(--background); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; text-decoration: none;}
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
        
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; position: relative; }
        .input { padding: 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; font-size: 1rem; margin-bottom: 12px; background: #fff; }
        
        header { background: var(--surface); box-shadow: var(--shadow); padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .nav-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .user-controls { display: flex; gap: 12px; align-items: center; }

        .wallet-display { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 8px 18px; border-radius: 30px; font-weight: 800; border: 1px solid var(--border); }
        .rank-badge { font-size: 0.7rem; color: white; padding: 2px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; }

        .subject-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-top: 40px; }
        .subject-card { height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border-radius: 24px; cursor: pointer; transition: 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .subject-card:hover { transform: translateY(-10px); filter: brightness(1.1); }
        .subject-card span { font-size: 3.5rem; margin-bottom: 10px; }

        .view-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #e2e8f0; padding: 5px; border-radius: 12px; width: fit-content; overflow-x: auto; }
        .v-tab { padding: 8px 24px; border-radius: 8px; cursor: pointer; font-weight: 700; color: var(--text-light); transition: 0.3s; white-space: nowrap;}
        .v-tab.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .mastery-ribbon { position: absolute; top: 15px; right: -30px; transform: rotate(45deg); width: 120px; text-align: center; font-size: 0.7rem; font-weight: 800; padding: 4px 0; color: white; z-index: 5; }
        .ribbon-gold { background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728); color: #5c4033; }
        .ribbon-silver { background: linear-gradient(to right, #70706f, #e7e7e7, #70706f); color: #333; }
        .ribbon-bronze { background: linear-gradient(to right, #804a00, #ec9d60, #804a00); color: white; }

        @keyframes struggle-pulse { 0% { color: var(--text); } 50% { color: var(--danger); font-weight: 900; } 100% { color: var(--text); } }
        .struggle-alert { animation: struggle-pulse 1.5s infinite; border-left: 4px solid var(--danger); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #edf2f7; }
        th { color: var(--text-light); font-size: 0.85rem; background: #f8fafc; }

        #main-spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        iframe { width: 100%; height: 75vh; border: none; border-radius: 16px; background: white; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 15px 30px; border-radius: 12px; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 9999; }
        .toast.show { opacity: 1; transform: translateY(-10px); }
    </style>
</head>
<body>

    <header>
        <div class="container nav-wrapper">
            <div class="logo" onclick="app.router.go('landing')">üéì EduQuest OS</div>
            <div id="header-controls" class="user-controls"></div>
        </div>
    </header>

    <main class="container">
        <div id="main-spinner"></div>

        <!-- VIEW: Landing -->
        <div id="view-landing" class="view-section">
            <div style="text-align: center; margin-top: 40px;">
                <h1 id="welcome-text">Welcome Back!</h1>
                <p style="color: var(--text-light); font-size: 1.1rem;">Choose a subject to begin your learning adventure.</p>
            </div>
            <div id="subject-container" class="subject-cards"></div>
            <div id="admin-entry" class="hidden" style="margin-top:80px; text-align:center; padding-top:20px; border-top:1px solid #ddd;">
                <button class="btn btn-outline" onclick="app.router.go('admin')">üõ†Ô∏è Lesson Editor (Admin)</button>
            </div>
        </div>

        <!-- VIEW: Shop -->
        <div id="view-shop" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')">‚Üê Back</button>
                <h2>üõí Classroom Shop</h2>
                <button class="btn btn-primary btn-sm" onclick="app.logic.showPurchaseHistory()">My Stuff</button>
            </div>
            <div id="student-shop-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
        </div>

        <!-- VIEW: Library -->
        <div id="view-library" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
                <div>
                    <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-bottom:10px;">‚Üê Back</button>
                    <h2 id="library-subject-title" style="font-size: 2rem;">Subject</h2>
                </div>
                <div class="view-tabs" style="margin-bottom:0;">
                    <div id="tab-btn-quests" class="v-tab active" onclick="app.logic.switchLibraryTab('quests')">üéØ My Quests</div>
                    <div id="tab-btn-explore" class="v-tab" onclick="app.logic.switchLibraryTab('explore')">üåê Explore</div>
                </div>
            </div>
            <div id="library-filters" class="card hidden">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <input type="text" id="filter-search" class="input" placeholder="Search..." oninput="app.logic.renderLibrary()" style="margin:0;">
                    <select id="filter-grade" class="input" onchange="app.logic.renderLibrary()" style="margin:0;">
                        <option value="">All Grades</option><option value="K">Grade K</option><option value="1">Grade 1</option><option value="2">Grade 2</option><option value="3">Grade 3</option><option value="4">Grade 4</option><option value="5">Grade 5</option><option value="6">Grade 6</option>
                    </select>
                    <button class="btn btn-outline" onclick="app.logic.refreshContent()">üîÑ Refresh</button>
                </div>
            </div>
            <div id="library-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;"></div>
        </div>

        <!-- VIEW: Game Player -->
        <div id="view-game" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center; background:#fff; padding:15px; border-radius:16px; box-shadow:var(--shadow);">
                <button class="btn btn-outline" onclick="app.logic.exitGame()">‚Üê Close</button>
                <div style="text-align: center;"><h3 id="game-player-title">Lesson</h3><div id="playing-status" style="font-size:0.75rem; color:var(--secondary);">‚óè Session Active</div></div>
                <div style="display:flex; gap: 12px; align-items: center;">
                    <div style="background:#f1f5f9; padding:8px 15px; border-radius:10px; font-weight:800;">Score: <span id="game-current-score">0</span></div>
                    <button class="btn btn-primary" onclick="app.logic.manualSave()">üíæ Save Progress</button>
                </div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
        </div>

        <!-- VIEW: Teacher Dashboard -->
        <div id="view-dashboard" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-outline" onclick="app.router.go('landing')">Home</button>
            </div>

            <div class="view-tabs">
                <div class="v-tab active" id="d-tab-monitor" onclick="app.dashboard.switchTab('monitor')">Live Monitor üü¢</div>
                <div class="v-tab" id="d-tab-class" onclick="app.dashboard.switchTab('class')">Manage Roster</div>
                <div class="v-tab" id="d-tab-assign" onclick="app.dashboard.switchTab('assign')">Assignments</div>
                <div class="v-tab" id="d-tab-shop" onclick="app.dashboard.switchTab('shop')">Shop Manager</div>
                <div class="v-tab" id="d-tab-grades" onclick="app.dashboard.switchTab('grades')">Gradebook</div>
            </div>

            <!-- DASH: MONITOR -->
            <div id="dash-monitor" class="dashboard-section">
                <div class="card">
                    <h3>Student Live Pulse</h3>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;">
                            <thead><tr><th>Student</th><th>Current Lesson/Topic</th><th>Recent Score</th><th>Rewards/Behavior</th></tr></thead>
                            <tbody id="monitor-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- DASH: ROSTER -->
            <div id="dash-class" class="dashboard-section hidden">
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px;">
                    <div class="card">
                        <h3>Add Student</h3>
                        <input type="text" id="new-student-name" class="input" placeholder="Full Name">
                        <select id="new-student-grade" class="input"><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                        <button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.createStudent()">Add Student</button>
                        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
                        <h4>Bulk Import</h4>
                        <input type="file" id="roster-csv" accept=".csv" class="input" style="font-size:0.8rem;">
                        <button class="btn btn-outline btn-sm" style="width:100%;" onclick="app.dashboard.importCSV()">Process CSV (Name, Grade)</button>
                    </div>
                    <div class="card">
                        <h3>Active Roster</h3>
                        <table style="width:100%;"><tbody id="student-list-body"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- DASH: ASSIGN -->
            <div id="dash-assign" class="dashboard-section hidden">
                <div class="card">
                    <h3>Push Assignments</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin:15px 0; background:#f8fafc; padding:20px; border-radius:12px;">
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">1. Subject</label>
                            <select id="assign-subject" class="input dynamic-subject-select" onchange="app.dashboard.loadAssignableGames()"></select>
                        </div>
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">2. Grade Filter</label>
                            <select id="assign-grade-filter" class="input" onchange="app.dashboard.loadAssignableGames()">
                                <option value="">All Grades</option><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">3. Choose Lesson</label>
                            <select id="assign-game" class="input"><option value="">Select a lesson...</option></select>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h4>Target Students</h4>
                        <div><button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleCheckboxes(true)">Check All</button><button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleCheckboxes(false)">Uncheck All</button></div>
                    </div>
                    <div id="assign-student-list" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:12px; padding:15px; margin-bottom:20px;"></div>
                    <button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.assignToSelected()">Push Assignment to Students</button>
                </div>
            </div>

            <!-- DASH: SHOP MANAGER -->
            <div id="dash-shop" class="dashboard-section hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card">
                        <h3>Reward Inventory</h3>
                        <input type="text" id="shop-name" class="input" placeholder="Reward Name (e.g. Extra Recess)">
                        <input type="number" id="shop-price" class="input" placeholder="Point Cost">
                        <button class="btn btn-primary" onclick="app.dashboard.addShopItem()">Add Reward</button>
                        <div id="admin-shop-list" style="margin-top:20px;"></div>
                    </div>
                    <div class="card">
                        <h3>Redemption Requests</h3>
                        <div id="redemption-list"></div>
                    </div>
                </div>
            </div>

            <!-- DASH: GRADEBOOK -->
            <div id="dash-grades" class="dashboard-section hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Mastery Gradebook</h3>
                        <button class="btn btn-outline btn-sm" onclick="app.dashboard.exportGrades()">üì• Download CSV</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin:15px 0;">
                        <select id="gb-filter-grade" class="input" onchange="app.dashboard.renderGrades()"><option value="">All Grades</option><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                        <select id="gb-filter-subject" class="input dynamic-subject-select" onchange="app.dashboard.renderGrades()"></select>
                        <select id="gb-filter-game" class="input" onchange="app.dashboard.renderGrades()"><option value="">All Lessons</option></select>
                    </div>
                    <div style="overflow-x:auto;"><table style="width:100%;"><thead><tr><th>Student</th><th>Lesson</th><th>Best Score</th><th>Accuracy</th><th>Last Attempt</th></tr></thead><tbody id="grade-body"></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- VIEW: Admin Editor -->
        <div id="view-admin" class="view-section hidden">
            <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-bottom:20px;">‚Üê Back</button>
            <div class="card">
                <h2>Lesson Editor</h2>
                <input type="text" id="adm-title" class="input" placeholder="Lesson Title">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <select id="adm-subj" class="input dynamic-subject-select"></select>
                    <select id="adm-grade" class="input"><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                    <input type="text" id="adm-topic" class="input" placeholder="Topic (e.g. Addition)">
                </div>
                <textarea id="adm-html" class="input" style="height:250px; font-family:monospace;" placeholder="Paste HTML/CSS/JS here..."></textarea>
                <button class="btn btn-primary" onclick="app.logic.publishGame()">Publish to Platform</button>
            </div>
        </div>

        <!-- VIEW: Auth -->
        <div id="view-teacher-login" class="view-section hidden">
            <div class="card" style="max-width:450px; margin:80px auto; text-align:center; padding:40px;">
                <h2>Teacher Portal</h2>
                <button class="btn btn-primary" onclick="app.auth.loginTeacher()" style="width:100%; padding:15px;">Sign in with Google</button>
                <div style="margin:25px; color:#cbd5e1;">OR</div>
                <button class="btn btn-outline" onclick="app.router.go('student-login')" style="width:100%;">Student Access</button>
            </div>
        </div>
        <div id="view-student-login" class="view-section hidden">
            <div class="card" style="max-width:450px; margin:80px auto; text-align:center; padding:40px;">
                <h2>Student Entrance</h2>
                <input type="text" id="student-login-code" class="input" placeholder="Example: alex-432" style="text-align:center;">
                <button class="btn btn-primary" onclick="app.auth.loginStudent()" style="width:100%; padding:15px;">Enter Classroom</button>
                <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-top:20px;">Cancel</button>
            </div>
        </div>

        <!-- Modal: My Stuff -->
        <div id="modal-stuff" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center;">
            <div class="card" style="width:90%; max-width:500px;">
                <h3>My Purchased Rewards</h3>
                <div id="stuff-list" style="margin:20px 0; max-height:300px; overflow-y:auto;"></div>
                <button class="btn btn-outline" onclick="document.getElementById('modal-stuff').classList.add('hidden')">Close</button>
            </div>
        </div>

    </main>

    <div id="toast" class="toast">Action Successful</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, setDoc, deleteDoc, onSnapshot, arrayUnion, writeBatch, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // CONFIG & CONSTANTS
        const SUBJECT_CONFIG = {
            math: { label: 'Math', icon: 'üßÆ', color: 'linear-gradient(135deg, #0077cc, #00a3ff)' },
            science: { label: 'Science', icon: 'üß¨', color: 'linear-gradient(135deg, #28a745, #5ddc79)' },
            ela: { label: 'ELA', icon: 'üìö', color: 'linear-gradient(135deg, #6f42c1, #a927f9)' },
            games: { label: 'Games', icon: 'üéÆ', color: 'linear-gradient(135deg, #fd7e14, #ff4500)', lockable: true }
        };

        const RANKS = [
            { min: 0, label: 'Apprentice', color: '#94a3b8' },
            { min: 250, label: 'Scholar', color: '#0077cc' },
            { min: 750, label: 'Master', color: '#6f42c1' },
            { min: 2000, label: 'Grandmaster', color: '#ffd700' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCYVPsTnfNnyYfmgyKqeTtIAg5qf-ganS4",
            authDomain: "visualizationpractice.firebaseapp.com",
            projectId: "visualizationpractice",
            storageBucket: "visualizationpractice.firebasestorage.app",
            messagingSenderId: "814840211812",
            appId: "1:814840211812:web:01543de18dc9cb3ce23271"
        };
        const ADMIN_EMAIL = "raymond.anacaya1992@gmail.com";
        const appInstance = initializeApp(firebaseConfig);
        const db = getFirestore(appInstance);
        const auth = getAuth(appInstance);

        const state = { 
            userType: null, currentUser: null, studentId: null, 
            selectedSubject: null, currentLibraryTab: 'quests',
            games: [], students: [], currentGame: null, liveScore: 0, 
            allGamesMap: {}, lastSessionData: {total: 0, correct: 0}
        };

        // UI HELPERS
        const ui = {
            spinner: (s) => document.getElementById('main-spinner').style.display = s ? 'block' : 'none',
            toast: (m) => { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); },
            initDynamicUI: () => {
                const container = document.getElementById('subject-container');
                if(!container) return; container.innerHTML = '';
                Object.keys(SUBJECT_CONFIG).forEach(key => {
                    const sub = SUBJECT_CONFIG[key];
                    const el = document.createElement('div');
                    el.className = 'subject-card';
                    el.style.background = sub.color;
                    el.innerHTML = `<span>${sub.icon}</span><h3>${sub.label}</h3>`;
                    el.onclick = () => app.logic.selectSubject(key);
                    container.appendChild(el);
                });
                document.querySelectorAll('.dynamic-subject-select').forEach(select => {
                    let html = '<option value="">All Subjects</option>'; Object.keys(SUBJECT_CONFIG).forEach(k => html += `<option value="${k}">${SUBJECT_CONFIG[k].label}</option>`);
                    select.innerHTML = html;
                });
            },
            getRank: (pts) => RANKS.filter(r => pts >= r.min).pop() || RANKS[0],
            confetti: () => confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 })
        };

        const router = {
            go: (viewId) => {
                if(viewId === 'admin' && prompt("Admin Pin:") !== "1030") return;
                document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
                const target = document.getElementById(`view-${viewId}`);
                if(target) target.classList.remove('hidden');
                if(viewId === 'dashboard') app.dashboard.init();
                if(viewId === 'shop') app.logic.renderShop();
                updateHeader(); window.scrollTo(0,0);
            }
        };

        const logic = {
            selectSubject: async (subj) => {
                if(!state.currentUser) return router.go('student-login');
                if(state.userType === 'student' && SUBJECT_CONFIG[subj].lockable && state.currentUser.gamesLocked) return alert("Your access to Games is currently locked by the teacher.");
                state.selectedSubject = subj;
                document.getElementById('library-subject-title').textContent = SUBJECT_CONFIG[subj].label;
                ui.spinner(true);
                const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj)));
                state.games = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
                if(state.userType === 'student') document.getElementById('filter-grade').value = state.currentUser.grade;
                logic.switchLibraryTab('quests');
                router.go('library');
                ui.spinner(false);
            },
            switchLibraryTab: (tab) => {
                state.currentLibraryTab = tab;
                document.getElementById('tab-btn-quests').classList.toggle('active', tab === 'quests');
                document.getElementById('tab-btn-explore').classList.toggle('active', tab === 'explore');
                document.getElementById('library-filters').classList.toggle('hidden', tab === 'quests');
                logic.renderLibrary();
            },
            renderLibrary: () => {
                const grid = document.getElementById('library-grid'); grid.innerHTML = '';
                const search = document.getElementById('filter-search').value.toLowerCase();
                const gradeF = document.getElementById('filter-grade').value;
                const assignedIds = state.currentUser?.assignments || [];

                state.games.forEach(g => {
                    if(state.currentLibraryTab === 'quests' && !assignedIds.includes(g.gameId)) return;
                    if(state.currentLibraryTab === 'explore' && gradeF && g.grade !== gradeF) return;
                    if(search && !g.title.toLowerCase().includes(search)) return;

                    const best = (state.currentUser?.scores?.[g.gameId]?.score) || 0;
                    let rib = '';
                    if(best >= 95) rib = '<div class="mastery-ribbon ribbon-gold">GOLD</div>';
                    else if(best >= 80) rib = '<div class="mastery-ribbon ribbon-silver">SILVER</div>';
                    else if(best > 0) rib = '<div class="mastery-ribbon ribbon-bronze">BRONZE</div>';

                    const canDelete = (state.userType === 'teacher' && (state.currentUser.uid === g.creatorId || state.currentUser.email === ADMIN_EMAIL));

                    const card = document.createElement('div');
                    card.className = 'card game-card';
                    card.innerHTML = `${rib}<h3>${g.title}</h3><p style="font-size:0.75rem;">${g.topic} ‚Ä¢ Gr ${g.grade}</p><div style="margin-top:auto; text-align:right;">
                        ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); app.logic.deleteGame('${g.docId}')">üóëÔ∏è</button>` : ''}
                        <button class="btn btn-primary btn-sm">Play</button></div>`;
                    card.onclick = () => logic.launchGame(g);
                    grid.appendChild(card);
                });
            },
            launchGame: async (g) => {
                state.currentGame = g; state.liveScore = 0; state.lastSessionData = {total: 0, correct: 0};
                document.getElementById('game-player-title').textContent = g.title;
                if(state.userType === 'student') {
                    await updateDoc(doc(db, "students", state.studentId), { 
                        status: `üïπÔ∏è Working on: ${g.topic} (${g.title})`, 
                        currentSessionScore: 0, 
                        lastActive: serverTimestamp() 
                    });
                }
                const best = (state.currentUser?.scores?.[g.gameId]?.score) || 0;
                document.getElementById('game-frame').srcdoc = `<script>window.INITIAL_SCORE = ${best};<\/script>` + g.htmlCode;
                router.go('game');
            },
            handleScoreUpdate: (data) => {
                state.liveScore = Math.round(data.score);
                state.lastSessionData = { total: data.total || 0, correct: data.correct || 0 };
                document.getElementById('game-current-score').textContent = state.liveScore;
                if(state.userType === 'student') {
                    updateDoc(doc(db, "students", state.studentId), { currentSessionScore: state.liveScore });
                    if(state.liveScore === 100) logic.manualSave(true); 
                }
            },
            manualSave: async (isAutoMastery = false) => {
                if(state.userType !== 'student' || !state.currentGame) return;
                const gId = state.currentGame.gameId;
                const scoreData = state.currentUser.scores?.[gId];
                
                let ptsToAdd = 0;
                let awardedNow = false;
                if(state.liveScore === 100 && (!scoreData || !scoreData.lifetimePointsAwarded)) {
                    ptsToAdd = 10;
                    awardedNow = true;
                    ui.confetti();
                }

                const scoreObj = { 
                    score: state.liveScore, 
                    total: state.lastSessionData.total,
                    correct: state.lastSessionData.correct,
                    date: new Date().toISOString(), 
                    lifetimePointsAwarded: awardedNow || (scoreData?.lifetimePointsAwarded || false) 
                };
                const best = (scoreData?.score) || 0;

                await updateDoc(doc(db, "students", state.studentId), {
                    [`scores.${gId}`]: state.liveScore >= best ? scoreObj : scoreData,
                    pointsBalance: increment(ptsToAdd),
                    totalPointsEverEarned: increment(ptsToAdd),
                    status: `‚úÖ Last Score: ${state.liveScore}% (${state.currentGame.title})`
                });

                if(awardedNow) ui.toast("+10 Mastery Points Earned! üí∞");
                else if(!isAutoMastery) ui.toast("Progress Saved!");
            },
            exitGame: () => { if(state.userType === 'student') updateDoc(doc(db, "students", state.studentId), { status: "Idle", currentSessionScore: 0 }); router.go('library'); },
            publishGame: async () => {
                const title = document.getElementById('adm-title').value;
                const html = document.getElementById('adm-html').value;
                if(!title || !html) return alert("Fill fields");
                const id = 'g_' + Date.now();
                await setDoc(doc(db, "games", id), { gameId: id, title, subject: document.getElementById('adm-subj').value, grade: document.getElementById('adm-grade').value, topic: document.getElementById('adm-topic').value, htmlCode: html, creatorId: state.currentUser.uid });
                ui.toast("Published!"); router.go('landing');
            },
            deleteGame: async (docId) => { if(confirm("Permanently delete?")) { await deleteDoc(doc(db, "games", docId)); logic.refreshContent(); } },
            refreshContent: () => { logic.selectSubject(state.selectedSubject); },
            renderShop: async () => {
                const snap = await getDocs(collection(db, "shop"));
                const grid = document.getElementById('student-shop-grid');
                if(!grid) return; grid.innerHTML = '';
                snap.forEach(d => {
                    grid.innerHTML += `<div class="card" style="text-align:center;"><h3>${d.data().name}</h3><p style="font-size:1.5rem; margin:10px 0;">üí∞ ${d.data().price}</p><button class="btn btn-primary" style="width:100%;" onclick="app.logic.buyItem('${d.id}', ${d.data().price}, '${d.data().name}')">Purchase</button></div>`;
                });
            },
            buyItem: async (id, pr, nm) => {
                if(state.currentUser.pointsBalance < pr) return alert("Not enough points!");
                const batch = writeBatch(db);
                batch.update(doc(db, "students", state.studentId), { pointsBalance: increment(-pr) });
                batch.add(collection(db, "redemptions"), { studentName: state.currentUser.name, itemName: nm, teacherId: state.currentUser.teacherId, status: 'pending', date: serverTimestamp() });
                await batch.commit(); ui.confetti(); ui.toast("Purchase successful! Teacher notified.");
            },
            showPurchaseHistory: async () => {
                const s = await getDocs(query(collection(db, "redemptions"), where("studentName", "==", state.currentUser.name)));
                const list = document.getElementById('stuff-list');
                list.innerHTML = s.docs.map(d => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${d.data().itemName}</b> <span style="float:right; font-size:0.7rem;">${d.data().status.toUpperCase()}</span></div>`).join('') || 'No purchases yet.';
                document.getElementById('modal-stuff').classList.remove('hidden');
            }
        };

        const dashboard = {
            init: () => dashboard.switchTab('monitor'),
            switchTab: (t) => {
                document.querySelectorAll('.dashboard-section').forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.v-tab').forEach(bt => bt.classList.remove('active'));
                const page = document.getElementById(`dash-${t}`);
                if(page) page.classList.remove('hidden');
                const btn = document.getElementById(`d-tab-${t}`);
                if(btn) btn.classList.add('active');
                if(t === 'monitor') dashboard.loadMonitor();
                if(t === 'class') dashboard.loadRoster();
                if(t === 'assign') { dashboard.loadAssignableGames(); dashboard.loadStudentsForAssignment(); }
                if(t === 'grades') dashboard.loadGrades();
                if(t === 'shop') dashboard.loadShopManager();
            },
            loadMonitor: () => {
                onSnapshot(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)), (snap) => {
                    const body = document.getElementById('monitor-body'); body.innerHTML = '';
                    snap.forEach(d => {
                        const s = d.data();
                        const struggle = s.currentSessionScore > 0 && s.currentSessionScore < 50;
                        body.innerHTML += `<tr>
                            <td class="${struggle ? 'struggle-alert' : ''}">${s.name} ${struggle ? '‚ö†Ô∏è' : ''}</td>
                            <td>${s.status || 'Idle'}</td>
                            <td>${s.currentSessionScore || 0}%</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="app.dashboard.adjustPoints('${d.id}', 10)">+10 Pts</button> 
                                <button class="btn btn-danger btn-sm" onclick="app.dashboard.adjustPoints('${d.id}', -10)">-10 Pts</button>
                            </td>
                        </tr>`;
                    });
                });
            },
            adjustPoints: async (id, amt) => {
                await updateDoc(doc(db, "students", id), { 
                    pointsBalance: increment(amt), 
                    totalPointsEverEarned: increment(amt > 0 ? amt : 0) 
                });
                ui.toast("Points adjusted!");
            },
            loadRoster: async () => {
                const s = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                const body = document.getElementById('student-list-body');
                body.innerHTML = s.docs.map(d => {
                    const data = d.data();
                    return `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px;"><b>${data.name}</b> (Gr ${data.grade})</td><td><code>${data.loginCode}</code></td><td>
                        <button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleUserLock('${d.id}', ${data.gamesLocked})">${data.gamesLocked ? 'üîì Unlock Games' : 'üîí Lock Games'}</button>
                        <button class="btn btn-danger btn-sm" onclick="app.dashboard.deleteStudent('${d.id}')">üóëÔ∏è</button>
                    </td></tr>`;
                }).join('');
            },
            toggleUserLock: async (id, curr) => {
                await updateDoc(doc(db, "students", id), { gamesLocked: !curr });
                dashboard.loadRoster();
            },
            deleteStudent: async (id) => {
                if(confirm("Delete this student permanently?")) {
                    await deleteDoc(doc(db, "students", id));
                    dashboard.loadRoster();
                }
            },
            loadAssignableGames: async () => {
                const subj = document.getElementById('assign-subject').value;
                const gradeF = document.getElementById('assign-grade-filter').value;
                const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj)));
                const select = document.getElementById('assign-game');
                let filtered = snap.docs.map(d => d.data());
                if(gradeF) filtered = filtered.filter(g => g.grade === gradeF);
                select.innerHTML = filtered.map(g => `<option value="${g.gameId}">[Gr ${g.grade}] ${g.title}</option>`).join('') || '<option value="">No games found</option>';
            },
            loadStudentsForAssignment: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                const list = document.getElementById('assign-student-list'); list.innerHTML = '';
                snap.forEach(d => {
                    list.innerHTML += `<label style="display:block; margin-bottom:8px; cursor:pointer;"><input type="checkbox" class="stu-assign-cb" value="${d.id}" checked> <b>${d.data().name}</b> (Grade ${d.data().grade})</label>`;
                });
            },
            toggleCheckboxes: (v) => document.querySelectorAll('.stu-assign-cb').forEach(c => c.checked = v),
            assignToSelected: async () => {
                const gId = document.getElementById('assign-game').value;
                const sIds = Array.from(document.querySelectorAll('.stu-assign-cb:checked')).map(c => c.value);
                if(!gId || sIds.length === 0) return alert("Select lesson and students");
                ui.spinner(true);
                await Promise.all(sIds.map(id => updateDoc(doc(db, "students", id), { assignments: arrayUnion(gId) })));
                ui.toast(`Successfully pushed lesson to ${sIds.length} students!`); ui.spinner(false);
            },
            loadGrades: async () => {
                const gSnap = await getDocs(collection(db, "games"));
                state.allGamesMap = {}; gSnap.forEach(d => state.allGamesMap[d.data().gameId] = d.data());
                const select = document.getElementById('gb-filter-game'); select.innerHTML = '<option value="">All Lessons</option>';
                Object.values(state.allGamesMap).forEach(g => select.innerHTML += `<option value="${g.gameId}">${g.title}</option>`);
                dashboard.renderGrades();
            },
            renderGrades: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                const body = document.getElementById('grade-body'); body.innerHTML = '';
                const gf = document.getElementById('gb-filter-grade').value, sf = document.getElementById('gb-filter-subject').value, gmf = document.getElementById('gb-filter-game').value;
                
                snap.forEach(d => {
                    const s = d.data(); if(gf && s.grade !== gf) return;
                    Object.keys(s.scores || {}).forEach(gid => {
                        const m = state.allGamesMap[gid]; if(!m) return;
                        if(sf && m.subject !== sf) return; if(gmf && gid !== gmf) return;
                        const sd = s.scores[gid];
                        body.innerHTML += `<tr><td>${s.name}</td><td>${m.title}</td><td style="font-weight:bold;">${sd.score}%</td><td>${sd.correct || 0} / ${sd.total || 0}</td><td>${new Date(sd.date).toLocaleDateString()}</td></tr>`;
                    });
                });
            },
            exportGrades: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                let csv = "Student,Subject,Lesson,Score,Accuracy,Date\n";
                snap.forEach(d => {
                    const s = d.data();
                    Object.keys(s.scores || {}).forEach(gid => {
                        const m = state.allGamesMap[gid]; if(!m) return;
                        const sd = s.scores[gid];
                        csv += `"${s.name}","${m.subject}","${m.title}","${sd.score}%","${sd.correct}/${sd.total}","${sd.date}"\n`;
                    });
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', 'eduquest_grades.csv');
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },
            importCSV: () => {
                const file = document.getElementById('roster-csv').files[0];
                if(!file) return alert("Select CSV file");
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const lines = e.target.result.split('\n').map(l => l.trim()).filter(l => l.length > 0 && l.toLowerCase() !== 'name');
                    const batch = writeBatch(db);
                    lines.forEach(line => {
                        const parts = line.split(',');
                        const name = parts[0], grade = parts[1]?.trim() || "1";
                        const code = name.split(' ')[0].toLowerCase() + '-' + Math.floor(100+Math.random()*899);
                        batch.set(doc(collection(db, "students")), { name, grade, loginCode: code, teacherId: state.currentUser.uid, scores: {}, assignments: [], pointsBalance: 0, totalPointsEverEarned: 0, gamesLocked: false, status: "Idle" });
                    });
                    await batch.commit(); dashboard.loadRoster(); ui.toast("Roster updated!");
                };
                reader.readAsText(file);
            },
            loadShopManager: async () => {
                const items = await getDocs(collection(db, "shop"));
                document.getElementById('admin-shop-list').innerHTML = items.docs.map(d => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:#f8fafc; padding:8px; border-radius:8px;"><span>${d.data().name} (${d.data().price} pts)</span><button class="btn btn-danger btn-sm" onclick="app.dashboard.deleteShopItem('${d.id}')">üóëÔ∏è</button></div>`).join('');
                onSnapshot(query(collection(db, "redemptions"), where("teacherId", "==", state.currentUser.uid), where("status", "==", "pending")), (snap) => {
                    document.getElementById('redemption-list').innerHTML = snap.docs.map(d => `<div class="card" style="padding:10px;"><b>${d.data().studentName}</b> requested ${d.data().itemName} <button class="btn btn-primary btn-sm" onclick="app.dashboard.completeOrder('${d.id}')">Approve ‚úÖ</button></div>`).join('') || '<p>No pending requests.</p>';
                });
            },
            addShopItem: async () => {
                const name = document.getElementById('shop-name').value;
                const price = parseInt(document.getElementById('shop-price').value);
                if(!name || isNaN(price)) return;
                await addDoc(collection(db, "shop"), { name, price });
                document.getElementById('shop-name').value = ''; document.getElementById('shop-price').value = '';
                dashboard.loadShopManager();
            },
            deleteShopItem: async (id) => { if(confirm("Remove item?")) { await deleteDoc(doc(db, "shop", id)); dashboard.loadShopManager(); } },
            completeOrder: async (id) => { await updateDoc(doc(db, "redemptions", id), { status: 'filled' }); ui.toast("Reward Approved!"); },
            createStudent: async () => {
                const name = document.getElementById('new-student-name').value;
                const grade = document.getElementById('new-student-grade').value;
                if(!name) return;
                const code = name.split(' ')[0].toLowerCase() + '-' + Math.floor(100+Math.random()*899);
                await addDoc(collection(db, "students"), { name, grade, loginCode: code, teacherId: state.currentUser.uid, pointsBalance: 0, totalPointsEverEarned: 0, scores: {}, assignments: [], gamesLocked: false, status: "Idle" });
                dashboard.loadRoster(); document.getElementById('new-student-name').value = '';
            }
        };

        const authService = {
            loginTeacher: async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); router.go('landing'); } catch(e) { alert(e.message); } },
            loginStudent: async () => {
                const code = document.getElementById('student-login-code').value.trim();
                const snap = await getDocs(query(collection(db, "students"), where("loginCode", "==", code)));
                if(snap.empty) return alert("Invalid Access Code");
                const d = snap.docs[0];
                state.userType = 'student'; state.currentUser = d.data(); state.studentId = d.id;
                localStorage.setItem('edu_student_id', d.id);
                router.go('landing');
            },
            logout: async () => { if(state.userType === 'teacher') await signOut(auth); state.userType = null; state.currentUser = null; localStorage.removeItem('edu_student_id'); router.go('landing'); },
            check: () => {
                onAuthStateChanged(auth, (user) => {
                    if(user) { state.userType = 'teacher'; state.currentUser = user; document.getElementById('admin-entry').classList.toggle('hidden', user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()); }
                    updateHeader();
                });
                const sid = localStorage.getItem('edu_student_id');
                if(sid) onSnapshot(doc(db, "students", sid), (d) => { if(d.exists()){ state.userType = 'student'; state.currentUser = d.data(); state.studentId = d.id; updateHeader(); } });
            }
        };

        function updateHeader() {
            const h = document.getElementById('header-controls'); if(!h) return;
            if(!state.userType || !state.currentUser) {
                h.innerHTML = `<button class="btn btn-outline btn-sm" onclick="app.router.go('teacher-login')">Teacher Portal</button> <button class="btn btn-primary btn-sm" onclick="app.router.go('student-login')">Student Entrance</button>`;
            } else {
                if(state.userType === 'student') {
                    const rank = ui.getRank(state.currentUser.totalPointsEverEarned || 0);
                    document.getElementById('welcome-text').textContent = `Hi, ${state.currentUser.name}! üëã`;
                    h.innerHTML = `<button class="btn btn-outline btn-sm" onclick="app.router.go('shop')">üõí Shop</button> <div class="wallet-display">üí∞ ${state.currentUser.pointsBalance || 0} <span class="rank-badge" style="background:${rank.color}">${rank.label}</span></div> <button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>`;
                } else {
                    h.innerHTML = `<button class="btn btn-primary btn-sm" onclick="app.router.go('dashboard')">Dashboard</button> <button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>`;
                }
            }
        }

        window.addEventListener('message', (e) => { if(e.data?.type === 'TOOL_SCORE') logic.handleScoreUpdate(e.data); });
        ui.initDynamicUI();
        authService.check();
        window.app = { router, logic, auth: authService, dashboard };
    </script>
</body>
</html>
