<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuest OS | Professional Learning Platform</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #0077cc; --secondary: #28a745; --ela: #6f42c1; --games: #fd7e14;
            --danger: #dc3545; --warning: #ffc107; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32;
            --background: #f0f4f8; --surface: #ffffff; --text: #333333; --text-light: #666666;
            --border: #dde1e6; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Nunito', sans-serif; }
        body { background-color: var(--background); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; text-decoration: none;}
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
        
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; position: relative; }
        .input { padding: 12px; border: 1px solid var(--border); border-radius: 10px; width: 100%; font-size: 1rem; margin-bottom: 12px; background: #fff; }
        
        header { background: var(--surface); box-shadow: var(--shadow); padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .nav-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary); cursor: pointer; }
        .user-controls { display: flex; gap: 12px; align-items: center; }

        .wallet-display { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 8px 18px; border-radius: 30px; font-weight: 800; border: 1px solid var(--border); }
        .rank-badge { font-size: 0.7rem; color: white; padding: 2px 10px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; }

        .subject-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-top: 40px; }
        .subject-card { height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border-radius: 24px; cursor: pointer; transition: 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
        .subject-card:hover { transform: translateY(-10px); filter: brightness(1.1); }
        .subject-card span { font-size: 3.5rem; margin-bottom: 10px; }

        .view-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #e2e8f0; padding: 5px; border-radius: 12px; width: fit-content; overflow-x: auto; }
        .v-tab { padding: 8px 24px; border-radius: 8px; cursor: pointer; font-weight: 700; color: var(--text-light); transition: 0.3s; white-space: nowrap;}
        .v-tab.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .mastery-ribbon { position: absolute; top: 15px; right: -30px; transform: rotate(45deg); width: 120px; text-align: center; font-size: 0.7rem; font-weight: 800; padding: 4px 0; color: white; z-index: 5; }
        .ribbon-gold { background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728); color: #5c4033; }
        .ribbon-silver { background: linear-gradient(to right, #70706f, #e7e7e7, #70706f); color: #333; }
        .ribbon-bronze { background: linear-gradient(to right, #804a00, #ec9d60, #804a00); color: white; }

        @keyframes struggle-pulse { 0% { color: var(--text); } 50% { color: var(--danger); font-weight: 900; } 100% { color: var(--text); } }
        .struggle-alert { animation: struggle-pulse 1.5s infinite; border-left: 4px solid var(--danger); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #edf2f7; }
        th { color: var(--text-light); font-size: 0.85rem; background: #f8fafc; }

        #main-spinner { display: none; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        iframe { width: 100%; height: 75vh; border: none; border-radius: 16px; background: white; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 15px 30px; border-radius: 12px; opacity: 0; pointer-events: none; transition: 0.4s; z-index: 9999; }
        .toast.show { opacity: 1; transform: translateY(-10px); }
        
        /* --- PROMPT FORGE WIZARD STYLES --- */
.wizard-container { padding: 20px; }
.wizard-step { display: none; animation: fadeIn 0.4s; }
.wizard-step.active { display: block; }

.category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
.category-card { 
    background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 20px; 
    cursor: pointer; transition: 0.3s; text-align: center;
}
.category-card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: var(--shadow); }
.category-card h4 { color: var(--primary); margin-bottom: 10px; }
.category-card p { font-size: 0.85rem; color: var(--text-light); }

.image-preview-box {
    border: 1px solid #cbd5e1; border-radius: 12px; overflow: hidden;
    background: #f8fafc; margin: 15px 0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}
.preview-header { background: #e2e8f0; padding: 8px 15px; display: flex; align-items: center; gap: 6px; }
.dot { width: 10px; height: 10px; border-radius: 50%; }
.red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }
.preview-url { margin-left: 10px; font-size: 0.7rem; color: #64748b; font-family: monospace; }
.preview-img { width: 100%; display: block; border-bottom: 1px solid #e2e8f0; min-height: 100px; background: #eee; object-fit: cover;}
.preview-caption { padding: 10px; font-size: 0.8rem; color: #475569; text-align: center; font-style: italic; }

.prompt-output { 
    background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 12px; 
    font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; margin: 15px 0;
    max-height: 300px; overflow-y: auto; border: 1px solid #334155;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Polish for Topic/Standard Labels */
#forge-inputs-area label {
    display: block;
    margin-bottom: 4px;
    color: var(--primary); /* Makes the field names stand out in blue */
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Ensure Topic/Standard inputs feel robust */
#forge-inputs-area .input {
    border: 2px solid #f1f5f9;
    transition: 0.3s;
}

#forge-inputs-area .input:focus {
    border-color: var(--primary);
    background: #fff;
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 119, 204, 0.1);
}

/* Make the textarea for PDF/Standards a bit taller for long text */
#forge-inputs-area textarea.input {
    min-height: 100px;
    line-height: 1.5;
}

    </style>
</head>
<body>

    <header>
        <div class="container nav-wrapper">
            <div class="logo" onclick="app.router.go('landing')">üéì EduQuest OS</div>
            <div id="header-controls" class="user-controls"></div>
        </div>
    </header>

    <main class="container">
        <div id="main-spinner"></div>

        <!-- VIEW: Landing -->
        <div id="view-landing" class="view-section">
            <div style="text-align: center; margin-top: 40px;">
                <h1 id="welcome-text">Welcome Back!</h1>
                <p style="color: var(--text-light); font-size: 1.1rem;">Choose a subject to begin your learning adventure.</p>
            </div>
            <div id="subject-container" class="subject-cards"></div>
            <div id="admin-entry" class="hidden" style="margin-top:80px; text-align:center; padding-top:20px; border-top:1px solid #ddd;">
                <button class="btn btn-outline" onclick="app.router.go('admin')">üõ†Ô∏è Lesson Editor (Admin)</button>
            </div>
        </div>

        <!-- VIEW: Shop -->
        <div id="view-shop" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')">‚Üê Back</button>
                <h2>üõí Classroom Shop</h2>
                <button class="btn btn-primary btn-sm" onclick="app.logic.showPurchaseHistory()">My Stuff</button>
            </div>
            <div id="student-shop-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
        </div>

        <!-- VIEW: Library -->
        <div id="view-library" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
                <div>
                    <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-bottom:10px;">‚Üê Back</button>
                    <h2 id="library-subject-title" style="font-size: 2rem;">Subject</h2>
                </div>
                <div class="view-tabs" style="margin-bottom:0;">
                    <div id="tab-btn-quests" class="v-tab active" onclick="app.logic.switchLibraryTab('quests')">üéØ My Quests</div>
                    <div id="tab-btn-explore" class="v-tab" onclick="app.logic.switchLibraryTab('explore')">üåê Explore</div>
                </div>
            </div>
            <div id="library-filters" class="card hidden">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <input type="text" id="filter-search" class="input" placeholder="Search..." oninput="app.logic.renderLibrary()" style="margin:0;">
                    <select id="filter-grade" class="input" onchange="app.logic.renderLibrary()" style="margin:0;">
                        <option value="">All Grades</option><option value="K">Grade K</option><option value="1">Grade 1</option><option value="2">Grade 2</option><option value="3">Grade 3</option><option value="4">Grade 4</option><option value="5">Grade 5</option><option value="6">Grade 6</option>
                    </select>
                    <button class="btn btn-outline" onclick="app.logic.refreshContent()">üîÑ Refresh</button>
                </div>
            </div>
            <div id="library-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;"></div>
        </div>

        <!-- VIEW: Game Player -->
        <div id="view-game" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center; background:#fff; padding:15px; border-radius:16px; box-shadow:var(--shadow);">
                <button class="btn btn-outline" onclick="app.logic.exitGame()">‚Üê Close</button>
                <div style="text-align: center;"><h3 id="game-player-title">Lesson</h3><div id="playing-status" style="font-size:0.75rem; color:var(--secondary);">‚óè Session Active</div></div>
                <div style="display:flex; gap: 12px; align-items: center;">
                    <div style="background:#f1f5f9; padding:8px 15px; border-radius:10px; font-weight:800;">Score: <span id="game-current-score">0</span></div>
                    <button class="btn btn-primary" onclick="app.logic.manualSave()">üíæ Save Progress</button>
                    <button class="btn btn-outline" onclick="app.logic.toggleFullscreen()">üì∫ Full Screen</button>
                </div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-modals allow-same-origin allow-popups allow-forms" allowfullscreen></iframe>
        </div>

        <!-- VIEW: Teacher Dashboard -->
        <div id="view-dashboard" class="view-section hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2>Teacher Dashboard</h2>
                <button class="btn btn-outline" onclick="app.router.go('landing')">Home</button>
            </div>

            <div class="view-tabs">
                <div class="v-tab active" id="d-tab-monitor" onclick="app.dashboard.switchTab('monitor')">Live Monitor üü¢</div>
                <div class="v-tab" id="d-tab-class" onclick="app.dashboard.switchTab('class')">Manage Roster</div>
                <div class="v-tab" id="d-tab-assign" onclick="app.dashboard.switchTab('assign')">Assignments</div>
                <div class="v-tab" id="d-tab-shop" onclick="app.dashboard.switchTab('shop')">Shop Manager</div>
                <div class="v-tab" id="d-tab-grades" onclick="app.dashboard.switchTab('grades')">Gradebook</div>
                <div class="v-tab" id="d-tab-groups" onclick="app.dashboard.switchTab('groups')">Groups üë•</div>
                <div class="v-tab" id="d-tab-forge" onclick="app.dashboard.switchTab('forge')">Prompt Forge üõ†Ô∏è</div>
            </div>

            <!-- DASH: MONITOR -->
            <!-- DASH: MONITOR -->
<div id="dash-monitor" class="dashboard-section">
    <div style="margin-bottom: 20px;">
        <h3>Live Classroom Pulse</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h3>Live Classroom Pulse üü¢</h3>
    <button class="btn btn-outline btn-sm" onclick="app.dashboard.loadMonitor()">üîÑ Refresh Data</button>
</div>

<div style="margin: 10px 0; display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px;">
    <label style="font-size: 0.8rem; font-weight: 800;">Filter Grade:</label>
    <select id="monitor-filter-grade" class="input" style="width: auto; margin: 0;" onchange="app.dashboard.loadMonitor()">
        <option value="">All Grades</option>
        <option value="K">K</option><option value="1">1</option><option value="2">2</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
    </select>
</div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- STUCK / HELP NEEDED -->
        <div class="card" style="border-top: 5px solid var(--danger);">
            <h4 style="color: var(--danger);">‚ö†Ô∏è Help Needed (Struggling)</h4>
            <table style="font-size: 0.85rem;">
                <thead><tr><th>Student</th><th>Topic</th><th>Score</th></tr></thead>
                <tbody id="monitor-stuck-body"></tbody>
            </table>
        </div>

        <!-- WORKING GREAT / ON TRACK -->
        <div class="card" style="border-top: 5px solid var(--secondary);">
            <h4 style="color: var(--secondary);">üåü On Track & High Achievers</h4>
            <table style="font-size: 0.85rem;">
                <thead><tr><th>Student</th><th>Topic</th><th>Score</th></tr></thead>
                <tbody id="monitor-track-body"></tbody>
            </table>
        </div>
    </div>
</div>

            <!-- DASH: ROSTER -->
            <div id="dash-class" class="dashboard-section hidden">
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px;">
                    <div class="card">
                        <h3>Add Student</h3>
                        <input type="text" id="new-student-name" class="input" placeholder="Full Name">
                        <select id="new-student-grade" class="input"><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                        <button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.createStudent()">Add Student</button>
                        <hr style="margin:25px 0; border:0; border-top:1px solid #eee;">
                        <h4>Bulk Import</h4>
                        <input type="file" id="roster-csv" accept=".csv" class="input" style="font-size:0.8rem;">
                        <button class="btn btn-outline btn-sm" style="width:100%;" onclick="app.dashboard.importCSV()">Process CSV (Name, Grade)</button>
                    </div>
                    <div class="card">
                        <h3>Active Roster</h3>
                        <div style="margin: 10px 0; display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px;">
    <label style="font-size: 0.8rem; font-weight: 800;">Filter by Grade:</label>
    <select id="roster-filter-grade" class="input" style="width: auto; margin: 0; padding: 5px 10px;" onchange="app.dashboard.loadRoster()">
        <option value="">All Students</option>
        <option value="K">Grade K</option>
        <option value="1">Grade 1</option>
        <option value="2">Grade 2</option>
        <option value="3">Grade 3</option>
        <option value="4">Grade 4</option>
        <option value="5">Grade 5</option>
        <option value="6">Grade 6</option>
    </select>
</div>
                        <div style="margin: 10px 0; display: flex; gap: 10px;">
    <button class="btn btn-danger btn-sm" onclick="app.dashboard.bulkToggleLock(true)">üîí Lock All Games</button>
    <button class="btn btn-outline btn-sm" onclick="app.dashboard.bulkToggleLock(false)">üîì Unlock All Games</button>
</div>
                        <table style="width:100%;"><tbody id="student-list-body"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- DASH: ASSIGN -->
            <div id="dash-assign" class="dashboard-section hidden">
                <div class="card">
                    <h3>Push Assignments</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:15px; margin:15px 0; background:#f8fafc; padding:20px; border-radius:12px;">
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">1. Subject</label>
                            <select id="assign-subject" class="input dynamic-subject-select" onchange="app.dashboard.loadAssignableGames()"></select>
                        </div>
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">2. Grade Filter</label>
                            <select id="assign-grade-filter" class="input" onchange="app.dashboard.loadAssignableGames()">
                                <option value="">All Grades</option><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.75rem; font-weight:800;">3. Choose Lesson</label>
                            <select id="assign-game" class="input"><option value="">Select a lesson...</option></select>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h4>Target Students</h4>
                        <div><button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleCheckboxes(true)">Check All</button><button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleCheckboxes(false)">Uncheck All</button></div>
                    </div>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #bae6fd;">
    <label style="font-weight:800; font-size:0.8rem;">üöÄ Fast Push to Group:</label>
    <div style="display:flex; gap:10px; margin-top:5px;">
        <select id="assign-group-select" class="input" style="margin:0;"><option value="">Loading Groups...</option></select>
        <button class="btn btn-primary" onclick="app.dashboard.assignToGroup()">Push to Group</button>
    </div>
</div>
                    <div id="assign-student-list" style="max-height:250px; overflow-y:auto; border:1px solid #eee; border-radius:12px; padding:15px; margin-bottom:20px;"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
    <button class="btn btn-primary" onclick="app.dashboard.assignToSelected()">üöÄ Push to Selected</button>
    <button class="btn btn-danger" onclick="app.dashboard.bulkUnassign()">üóëÔ∏è Remove from Selected</button>
</div>
                </div>
            </div>

            <!-- DASH: SHOP MANAGER -->
            <div id="dash-shop" class="dashboard-section hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div class="card">
                        <h3>Reward Inventory</h3>
                        <input type="text" id="shop-name" class="input" placeholder="Reward Name (e.g. Extra Recess)">
                        <input type="number" id="shop-price" class="input" placeholder="Point Cost">
                        <button class="btn btn-primary" onclick="app.dashboard.addShopItem()">Add Reward</button>
                        <div id="admin-shop-list" style="margin-top:20px;"></div>
                    </div>
                    <div class="card">
                        <h3>Redemption Requests</h3>
                        <div id="redemption-list"></div>
                    </div>
                </div>
            </div>

            <!-- DASH: GRADEBOOK -->
            <div id="dash-grades" class="dashboard-section hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Mastery Gradebook</h3>
                        <button class="btn btn-outline btn-sm" onclick="app.dashboard.exportGrades()">üì• Download CSV</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin:15px 0;">
                        <select id="gb-filter-grade" class="input" onchange="app.dashboard.updateGradebookLessonFilter(); app.dashboard.renderGrades()"><option value="">All Grades</option><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                        <select id="gb-filter-subject" class="input dynamic-subject-select" onchange="app.dashboard.updateGradebookLessonFilter(); app.dashboard.renderGrades()"></select>
                        <select id="gb-filter-game" class="input" onchange="app.dashboard.renderGrades()"><option value="">All Lessons</option></select>
                        <button class="btn btn-danger btn-sm" onclick="app.dashboard.resetTopicScores()" style="white-space: nowrap;">üßπ Reset Topic Scores</button>
                    </div>
                    <div style="overflow-x:auto;"><table style="width:100%;"><thead><tr><th>Student</th><th>Lesson</th><th>Best Score</th><th>Accuracy</th><th>Last Attempt</th></tr></thead><tbody id="grade-body"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <!-- DASH: GROUPS -->
<div id="dash-groups" class="dashboard-section hidden">
    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px;">
        <div class="card">
            <h3>Create New Group</h3>
            <input type="text" id="new-group-name" class="input" placeholder="e.g., Reading Group A">
            <button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.createGroup()">Create Group</button>
            <hr style="margin:20px 0; opacity:0.1;">
            <h4>Add Student to Group</h4>
            <h4>Manage Group Members</h4>
<!-- 1. Select the group you want to edit -->
<select id="group-select-list" class="input" onchange="app.dashboard.renderGroupChecklist()">
    <option value="">Choose a Group...</option>
</select>

<!-- 2. The Checkbox List (Scrollable) -->
<div id="group-checkbox-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff; margin-bottom: 10px;">
    <p style="font-size: 0.75rem; color: #666;">Select a group above to see students...</p>
</div>

<button class="btn btn-primary" style="width:100%;" onclick="app.dashboard.saveGroupBatch()">‚úÖ Save Group Members</button>
        </div>
        <div id="group-display-area" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"></div>
    </div>
</div>
        
        
        <!-- DASH: PROMPT FORGE WIZARD -->
<div id="dash-forge" class="dashboard-section hidden">
    <div class="card wizard-container">
        
        <!-- STAGE 1: CHOOSE CATEGORY -->
        <div id="forge-step-1" class="wizard-step active">
            <h2 style="text-align:center;">What are you building today?</h2>
            <p style="text-align:center; color:var(--text-light);">Select the type of logic for your lesson.</p>
            <div class="category-grid">
                <div class="category-card" onclick="app.forge.selectCategory('smart')">
                    <h4>üéØ Smart Score</h4>
                    <p>Random questions. Score goes up for right answers, down for wrong. Best for skill mastery.</p>
                </div>
                <div class="category-card" onclick="app.forge.selectCategory('assessment')">
                    <h4>üìù Assessment</h4>
                    <p>Formal Test style. Stimulus on the left, questions on the right. Records a final grade.</p>
                </div>
                <div class="category-card" onclick="app.forge.selectCategory('multi')">
                    <h4>üìÖ Multi-Activity</h4>
                    <p>Scaffolded learning. 5 different activities (Day 1-5). Best for a full unit.</p>
                </div>
            </div>
        </div>

        <!-- STAGE 2: BUILDER & INPUTS -->
        <div id="forge-step-2" class="wizard-step">
            <button class="btn btn-outline btn-sm" onclick="app.forge.goToStep(1)">‚Üê Back</button>
            <h3 style="margin-top:15px;">Lesson Details</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:15px;">
                <div>
                    <label style="font-size:0.8rem; font-weight:800;">1. Choose Builder</label>
                    <select id="forge-builder-select" class="input" onchange="app.forge.renderInputs()"></select>
                    <div id="forge-inputs-area"></div>
                    <label style="display:flex; align-items:center; gap:10px; margin-top:15px; cursor:pointer;">
                        <input type="checkbox" id="forge-check-readaloud"> <span>Include <b>Read Aloud</b> (Voice)</span>
                    </label>
                </div>
                <div style="background:#f8fafc; padding:20px; border-radius:12px; border:1px dashed #cbd5e1;">
                    <h4>How it works:</h4>
                    <p style="font-size:0.85rem; color:var(--text-light);">Fill in these details. We will use them to write a "Senior Developer" prompt for the AI to follow.</p>
                    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="app.forge.generateAndGo()">Continue to Instructions ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- STAGE 3: THE WIZARD INSTRUCTIONS -->
        <div id="forge-step-3" class="wizard-step">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Step-by-Step Integration</h3>
                <button class="btn btn-outline btn-sm" onclick="app.forge.goToStep(1)">Start Over</button>
            </div>
            
            <div style="margin-top:20px;">
                <h4>Step 1: Set up Gemini</h4>
                <p>Open Gemini (Google), click <b>Gemini Advanced</b> (or Pro), and ensure Canva/Tools are ready.</p>
                <div class="image-preview-box">
                    <div class="preview-header"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span><span class="preview-url">Gemini Setup</span></div>
                    <img src="https://raw.githubusercontent.com/raymondanacaya1992-ship-it/lessonmaker/main/Capture.JPG" class="preview-img">
                    <p class="preview-caption">Locate the settings icon or the "Advanced" toggle.</p>
                </div>

                <hr style="margin:25px 0; opacity:0.2;">

                <h4>Step 2: Copy the Master Prompt</h4>
                <p>Copy this huge block of instructions and paste it into Gemini/Claude.</p>
                <div id="master-prompt-box" class="prompt-output"></div>
                <button class="btn btn-primary" onclick="app.forge.copy('master-prompt-box')">üìã Copy Master Prompt</button>

                <hr style="margin:25px 0; opacity:0.2;">

                <h4>Step 3: The Technical Patch (CRITICAL)</h4>
                <p>Once the AI gives you code, if it doesn't save correctly, paste this "Checker" into the bottom of the AI chat.</p>
                <div id="checker-prompt-box" class="prompt-output"></div>
                <button class="btn btn-outline" onclick="app.forge.copy('checker-prompt-box')">üìã Copy Technical Checker</button>

                <hr style="margin:25px 0; opacity:0.2;">

                <h4>Step 4: Deploy to EduQuest</h4>
                <p>Once satisfied, copy the final HTML from the AI. Go to the <b>Admin Lesson Editor</b> (Pin: 1030) and paste your code.</p>
                <button class="btn btn-primary" onclick="app.router.go('admin')">üöÄ Open Lesson Editor Now</button>
            </div>
        </div>

    </div>
</div>

<!-- VIEW: Student Profile (Quest Log) -->
<div id="view-profile" class="view-section hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow);">
        <div>
            <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-bottom:10px;">‚Üê Back to Map</button>
            <h2 id="profile-student-name">My Quests</h2>
        </div>
        <div style="text-align: right;">
            <div id="quest-completion-stats" style="font-weight: 800; color: var(--primary); font-size: 1.2rem;">0/0 Quests</div>
            <div style="font-size: 0.8rem; color: var(--text-light);">Active Assignments</div>
        </div>
    </div>

    <div id="profile-quest-list">
        <!-- Quests will be grouped by subject here -->
    </div>
</div>

        <!-- VIEW: Admin Editor -->
        <div id="view-admin" class="view-section hidden">
            <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-bottom:20px;">‚Üê Back</button>
            <div class="card">
                <h2>Lesson Editor</h2>
                <input type="text" id="adm-title" class="input" placeholder="Lesson Title">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <select id="adm-subj" class="input dynamic-subject-select"></select>
                    <select id="adm-grade" class="input"><option value="K">K</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                    <input type="text" id="adm-topic" class="input" placeholder="Topic (e.g. Addition)">
                </div>
                <div style="margin-bottom:15px;">
    <label style="font-size: 0.8rem; font-weight: 800; color: var(--primary);">External Game Link (e.g. Netlify/Itch.io):</label>
    <input type="text" id="adm-url" class="input" placeholder="https://halogame2026.netlify.app/">
</div>
                <textarea id="adm-html" class="input" style="height:250px; font-family:monospace;" placeholder="Paste HTML/CSS/JS here..."></textarea>
                <button class="btn btn-primary" onclick="app.logic.publishGame()">Publish to Platform</button>
                <button class="btn btn-outline" onclick="state.editingGameId = null; app.router.go('landing')">Cancel</button>
            </div>
        </div>

        <!-- VIEW: Auth -->
        <div id="view-teacher-login" class="view-section hidden">
            <div class="card" style="max-width:450px; margin:80px auto; text-align:center; padding:40px;">
                <h2>Teacher Portal</h2>
                <button class="btn btn-primary" onclick="app.auth.loginTeacher()" style="width:100%; padding:15px;">Sign in with Google</button>
                <div style="margin:25px; color:#cbd5e1;">OR</div>
                <button class="btn btn-outline" onclick="app.router.go('student-login')" style="width:100%;">Student Access</button>
            </div>
        </div>
        <div id="view-student-login" class="view-section hidden">
            <div class="card" style="max-width:450px; margin:80px auto; text-align:center; padding:40px;">
                <h2>Student Entrance</h2>
                <input type="text" id="student-login-code" class="input" placeholder="Example: alex-432" style="text-align:center;">
                <button class="btn btn-primary" onclick="app.auth.loginStudent()" style="width:100%; padding:15px;">Enter Classroom</button>
                <button class="btn btn-outline btn-sm" onclick="app.router.go('landing')" style="margin-top:20px;">Cancel</button>
            </div>
        </div>

        <!-- Modal: My Stuff -->
        <div id="modal-stuff" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center;">
            <div class="card" style="width:90%; max-width:500px;">
                <h3>My Purchased Rewards</h3>
                <div id="stuff-list" style="margin:20px 0; max-height:300px; overflow-y:auto;"></div>
                <button class="btn btn-outline" onclick="document.getElementById('modal-stuff').classList.add('hidden')">Close</button>
            </div>
        </div>
        
        <!-- Modal: Assignment Manager -->
<div id="modal-assignments" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; display:flex; align-items:center; justify-content:center;">
    <div class="card" style="width:90%; max-width:500px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="manage-quest-name">Student's Quests</h3>
            <button class="btn btn-outline btn-sm" onclick="document.getElementById('modal-assignments').classList.add('hidden')">Close</button>
        </div>
        <div id="active-assignments-list" style="max-height:400px; overflow-y:auto; border:1px solid #eee; border-radius:12px; padding:10px;">
            <!-- Assignments show up here -->
        </div>
    </div>
</div>

    </main>

    <div id="toast" class="toast">Action Successful</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, setDoc, deleteDoc, onSnapshot, arrayUnion, arrayRemove, writeBatch, serverTimestamp, increment, deleteField } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // CONFIG & CONSTANTS
        const SUBJECT_CONFIG = {
            math: { label: 'Math', icon: 'üßÆ', color: 'linear-gradient(135deg, #0077cc, #00a3ff)' },
            science: { label: 'Science', icon: 'üß¨', color: 'linear-gradient(135deg, #28a745, #5ddc79)' },
            ela: { label: 'ELA', icon: 'üìö', color: 'linear-gradient(135deg, #6f42c1, #a927f9)' },
            games: { label: 'Games', icon: 'üéÆ', color: 'linear-gradient(135deg, #fd7e14, #ff4500)', lockable: true }
        };

        const RANKS = [
            { min: 0, label: 'Apprentice', color: '#94a3b8' },
            { min: 250, label: 'Scholar', color: '#0077cc' },
            { min: 750, label: 'Master', color: '#6f42c1' },
            { min: 2000, label: 'Grandmaster', color: '#ffd700' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCYVPsTnfNnyYfmgyKqeTtIAg5qf-ganS4",
            authDomain: "visualizationpractice.firebaseapp.com",
            projectId: "visualizationpractice",
            storageBucket: "visualizationpractice.firebasestorage.app",
            messagingSenderId: "814840211812",
            appId: "1:814840211812:web:01543de18dc9cb3ce23271"
        };
        const ADMIN_EMAIL = "raymond.anacaya1992@gmail.com";
        const appInstance = initializeApp(firebaseConfig);
        const db = getFirestore(appInstance);
        const auth = getAuth(appInstance);

        const state = { 
            userType: null, currentUser: null, studentId: null, 
            selectedSubject: null, currentLibraryTab: 'quests',
            editingGameId: null, // Track if we are editing an existing lesson
            games: [], students: [], currentGame: null, liveScore: 0, 
            allGamesMap: {}, lastSessionData: {total: 0, correct: 0}
        };

        // UI HELPERS
        const ui = {
            spinner: (s) => document.getElementById('main-spinner').style.display = s ? 'block' : 'none',
            toast: (m) => { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); },
            initDynamicUI: () => {
                const container = document.getElementById('subject-container');
                if(!container) return; container.innerHTML = '';
                Object.keys(SUBJECT_CONFIG).forEach(key => {
                    const sub = SUBJECT_CONFIG[key];
                    const el = document.createElement('div');
                    el.className = 'subject-card';
                    el.style.background = sub.color;
                    el.innerHTML = `<span>${sub.icon}</span><h3>${sub.label}</h3>`;
                    el.onclick = () => app.logic.selectSubject(key);
                    container.appendChild(el);
                });
                document.querySelectorAll('.dynamic-subject-select').forEach(select => {
                    let html = '<option value="">All Subjects</option>'; Object.keys(SUBJECT_CONFIG).forEach(k => html += `<option value="${k}">${SUBJECT_CONFIG[k].label}</option>`);
                    select.innerHTML = html;
                });
            },
            getRank: (pts) => RANKS.filter(r => pts >= r.min).pop() || RANKS[0],
            confetti: () => confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 })
        };

        const router = {
            go: (viewId) => {
                if(viewId === 'admin' && prompt("Admin Pin:") !== "1030") return;
                document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
                const target = document.getElementById(`view-${viewId}`);
                if(target) target.classList.remove('hidden');
                if(viewId === 'dashboard') app.dashboard.init();
                if(viewId === 'shop') app.logic.renderShop();
                updateHeader(); window.scrollTo(0,0);
            }
        };

        const logic = {
            selectSubject: async (subj) => {
                if(!state.currentUser) return router.go('student-login');
                
                // --- FAST PASS LOGIC FOR GAMES ---
                if(subj === 'games') {
                    // This tells the app to skip the list and open your Netlify site immediately
                    const gamePortal = {
                        title: "Game Arcade",
                        externalUrl: "https://halogame2026.netlify.app/",
                        topic: "Arcade"
                    };
                    app.logic.launchGame(gamePortal);
                    return; // Stop here so it doesn't open the library
                }

                if(state.userType === 'student' && SUBJECT_CONFIG[subj].lockable && state.currentUser.gamesLocked) {
                    return alert("Your access to Games is currently locked by the teacher.");
                }

                state.selectedSubject = subj;
                document.getElementById('library-subject-title').textContent = SUBJECT_CONFIG[subj].label;
                ui.spinner(true);
                
                const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj)));
                state.games = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
                
                if(state.userType === 'student') document.getElementById('filter-grade').value = state.currentUser.grade;
                logic.switchLibraryTab('quests');
                router.go('library');
                ui.spinner(false);
            },
            
            // --- ADD THESE INSIDE THE app.logic OBJECT ---

analyzeLessonParts: (htmlCode) => {
                if (!htmlCode) return 1;
                
                let foundNumbers = [1]; // Always assume at least 1 part

                // 1. Look for patterns like "Day 1", "Day 5", "Part 3", "Step 2", "Activity 4"
                // This catches text inside buttons, headings, and labels
                const textMatches = htmlCode.match(/(?:Day|Part|Step|Activity|Task|Module|Level)\s*(\d+)/gi);
                if (textMatches) {
                    textMatches.forEach(m => {
                        const num = parseInt(m.match(/\d+/));
                        if (num) foundNumbers.push(num);
                    });
                }

                // 2. Look for IDs or Classes like id="day5", class="tab-3", id="box-2"
                const attrMatches = htmlCode.match(/(?:id|class|data-id)=["'](?:day|tab|step|part|box|activity|page)-?(\d+)["']/gi);
                if (attrMatches) {
                    attrMatches.forEach(m => {
                        const num = parseInt(m.match(/\d+/));
                        if (num) foundNumbers.push(num);
                    });
                }

                // 3. Look for JS functions that use numbers: show(1), goTo(5), setTab(3)
                const jsMatches = htmlCode.match(/(?:show|go|set|open|select)(?:Day|Tab|Part|Step|Activity)?\s*\(\s*(\d+)\s*\)/gi);
                if (jsMatches) {
                    jsMatches.forEach(m => {
                        const num = parseInt(m.match(/\d+/));
                        if (num) foundNumbers.push(num);
                    });
                }

                // 4. Look for "Boxes" or "Grid Items" that might be days
                // Some AI code uses <div class="day-box">1</div>
                const boxMatches = htmlCode.match(/class=["'][^"']*(?:box|card|btn|square)[^"']*["'][^>]*>\s*(\d+)\s*</gi);
                if (boxMatches) {
                    boxMatches.forEach(m => {
                        const num = parseInt(m.match(/>\s*(\d+)\s*</)[1]);
                        if (num) foundNumbers.push(num);
                    });
                }

                // Return the HIGHEST number found (capped at 50 to avoid weird bugs)
                const maxFound = Math.max(...foundNumbers);
                return maxFound > 50 ? 1 : maxFound;
            },

renderProfile: async () => {
    ui.spinner(true);
    const container = document.getElementById('profile-quest-list');
    const statsHeader = document.getElementById('quest-completion-stats');
    const nameHeader = document.getElementById('profile-student-name');
    container.innerHTML = '';
    
    nameHeader.textContent = `${state.currentUser.name}'s Quest Log ‚öîÔ∏è`;

    // 1. Get all assigned game IDs
    const assignedIds = state.currentUser.assignments || [];
    if (assignedIds.length === 0) {
        container.innerHTML = `<div class="card" style="text-align:center; padding:40px;"><h3>No quests assigned yet!</h3><p>Check back later or ask your teacher.</p></div>`;
        statsHeader.textContent = "0/0 Quests";
        ui.spinner(false);
        return;
    }

    // 2. To avoid Firebase Read spikes, we only fetch the games the student is actually assigned
    // We fetch them all at once using the 'where in' query
    const gamesSnap = await getDocs(query(collection(db, "games"), where("gameId", "in", assignedIds)));
    const assignedGames = gamesSnap.docs.map(d => d.data());

    // 3. Filter for UNFINISHED only (Score < 100)
    const unfinished = assignedGames.filter(g => {
        const score = state.currentUser.scores?.[g.gameId]?.score || 0;
        return score < 100;
    });

    statsHeader.textContent = `${assignedIds.length - unfinished.length} / ${assignedIds.length} Finished`;

    // 4. Group by Subject
    const grouped = {};
    unfinished.forEach(g => {
        if (!grouped[g.subject]) grouped[g.subject] = [];
        grouped[g.subject].push(g);
    });

    // 5. Build the UI
    if (unfinished.length === 0) {
        container.innerHTML = `<div class="card" style="text-align:center; padding:40px; border: 2px dashed var(--secondary);">
            <h2 style="color:var(--secondary);">üéâ All Quests Complete!</h2>
            <p>You've finished everything your teacher assigned. Great job!</p>
        </div>`;
    } else {
        Object.keys(grouped).forEach(subKey => {
            const subInfo = SUBJECT_CONFIG[subKey] || { label: subKey, color: '#666' };
            const section = document.createElement('div');
            section.innerHTML = `<h3 style="margin: 20px 0 10px 10px; display:flex; align-items:center; gap:10px;">
                <span style="background:${subInfo.color}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span>
                ${subInfo.label}
            </h3>`;
            
            const grid = document.createElement('div');
grid.style.display = 'flex';
grid.style.flexDirection = 'column'; // This makes them stack vertically (list)
grid.style.gap = '12px';

            grouped[subKey].forEach(game => {
    const score = state.currentUser.scores?.[game.gameId]?.score || 0;
    const totalParts = app.logic.analyzeLessonParts(game.htmlCode);
    
    // 1. The Bar should ALWAYS match the actual score percentage
    const progressPercent = score; 

    // 2. Calculate which "Day" or "Part" they are currently on
    let currentPart = Math.floor((score / 100) * totalParts) + 1;
    
    // 3. Safety cap: Don't let currentPart exceed the total number of parts
    if (currentPart > totalParts) currentPart = totalParts;

                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.style.transition = '0.2s';
                card.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="flex: 2;">
            <h4 style="margin:0; color:var(--primary);">${game.title}</h4>
            <p style="font-size:0.75rem; color:var(--text-light); margin:2px 0;">${game.topic}</p>
        </div>
        
        <div style="flex: 3; padding: 0 20px;">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; margin-bottom:4px;">
                <span>${totalParts > 1 ? 'Part ' + Math.min(currentPart, totalParts) + ' of ' + totalParts : 'In Progress'}</span>
                <span style="font-weight:bold;">${score}%</span>
            </div>
            <div style="width:100%; height:8px; background:#eee; border-radius:10px; overflow:hidden;">
                <div style="width:${progressPercent}%; height:100%; background:var(--primary); transition:0.5s;"></div>
            </div>
        </div>
        
        <div style="flex: 1; text-align: right;">
            <button class="btn btn-primary btn-sm" style="white-space:nowrap;">Play ‚Üí</button>
        </div>
    </div>
`;
                card.onclick = () => app.logic.launchGame(game);
                grid.appendChild(card);
            });
            
            section.appendChild(grid);
            container.appendChild(section);
        });
    }

    ui.spinner(false);
},
            switchLibraryTab: (tab) => {
                state.currentLibraryTab = tab;
                document.getElementById('tab-btn-quests').classList.toggle('active', tab === 'quests');
                document.getElementById('tab-btn-explore').classList.toggle('active', tab === 'explore');
                document.getElementById('library-filters').classList.toggle('hidden', tab === 'quests');
                logic.renderLibrary();
            },
            renderLibrary: () => {
                const grid = document.getElementById('library-grid'); grid.innerHTML = '';
                const search = document.getElementById('filter-search').value.toLowerCase();
                const gradeF = document.getElementById('filter-grade').value;
                const assignedIds = state.currentUser?.assignments || [];

                state.games.forEach(g => {
                    if(state.currentLibraryTab === 'quests' && !assignedIds.includes(g.gameId)) return;
                    if(state.currentLibraryTab === 'explore' && gradeF && g.grade !== gradeF) return;
                    if(search && !g.title.toLowerCase().includes(search)) return;

                    const best = (state.currentUser?.scores?.[g.gameId]?.score) || 0;
                    let rib = '';
                    if(best >= 95) rib = '<div class="mastery-ribbon ribbon-gold">GOLD</div>';
                    else if(best >= 80) rib = '<div class="mastery-ribbon ribbon-silver">SILVER</div>';
                    else if(best > 0) rib = '<div class="mastery-ribbon ribbon-bronze">BRONZE</div>';

                    const canDelete = (state.userType === 'teacher' && (state.currentUser.uid === g.creatorId || state.currentUser.email === ADMIN_EMAIL));

const card = document.createElement('div');
card.className = 'card game-card';
card.innerHTML = `
    ${rib}
    <h3>${g.title}</h3>
    <p style="font-size:0.75rem;">${g.topic} ‚Ä¢ Gr ${g.grade}</p>
    <div style="margin-top:auto; text-align:right; display:flex; gap:5px; justify-content:flex-end;">
        ${canDelete ? `<button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); app.logic.prepareEdit('${g.gameId}')">‚úèÔ∏è Edit</button>` : ''}
        ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); app.logic.deleteGame('${g.docId}')">üóëÔ∏è</button>` : ''}
        <button class="btn btn-primary btn-sm">Play</button>
    </div>`;
                    card.onclick = () => logic.launchGame(g);
                    grid.appendChild(card);
                });
            },
            launchGame: async (g) => {
                state.currentGame = g; 
                state.liveScore = 0; 
                state.lastSessionData = {total: 0, correct: 0};
                
                // Set the header title
                document.getElementById('game-player-title').textContent = g.title;
                
                const frame = document.getElementById('game-frame');

                // THE PROJECTOR LOGIC
                if (g.externalUrl && g.externalUrl.trim() !== "") {
                    // 1. If there's a link, we must CLEAR the srcdoc first
                    frame.removeAttribute('srcdoc'); 
                    // 2. Then set the src to the website URL
                    frame.src = g.externalUrl; 
                } else {
                    // 1. If it's code, we CLEAR the src URL first
                    frame.src = ""; 
                    // 2. Then inject the HTML code
                    const best = (state.currentUser?.scores?.[g.gameId]?.score) || 0;
                    frame.srcdoc = `<script>window.INITIAL_SCORE = ${best};<\/script>` + (g.htmlCode || "");
                }

                if(state.userType === 'student') {
                    await updateDoc(doc(db, "students", state.studentId), { 
                        status: `üïπÔ∏è In Arcade: ${g.title}`, 
                        currentSessionScore: 0, 
                        lastActive: serverTimestamp() 
                    });
                }
                router.go('game');
            },

            toggleFullscreen: () => {
                const elem = document.getElementById("game-frame");
                if (elem.requestFullscreen) { elem.requestFullscreen(); }
                else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
                else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
            },
            
            prepareEdit: (gameId) => {
    const game = state.games.find(g => g.gameId === gameId);
    if (!game) return;

    state.editingGameId = game.gameId; // Tell the app we are editing
    
    // Fill the editor boxes with the old data
    document.getElementById('adm-title').value = game.title;
    document.getElementById('adm-subj').value = game.subject;
    document.getElementById('adm-grade').value = game.grade;
    document.getElementById('adm-topic').value = game.topic;
    document.getElementById('adm-html').value = game.htmlCode;

    // Change the button text so you know it's an update
    document.querySelector('#view-admin .btn-primary').textContent = "Update Lesson Content";
    
    // Go to the admin page
    document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
    document.getElementById('view-admin').classList.remove('hidden');
},

            handleScoreUpdate: (data) => {
                state.liveScore = Math.round(data.score);
                state.lastSessionData = { total: data.total || 0, correct: data.correct || 0 };
                document.getElementById('game-current-score').textContent = state.liveScore;
                
                if(state.userType === 'student') {
                    // We save the raw numbers (correct/total) so the Monitor can see them
                    updateDoc(doc(db, "students", state.studentId), { 
                        currentSessionScore: state.liveScore,
                        currentSessionTotal: data.total || 0,
                        currentSessionCorrect: data.correct || 0
                    });
                    if(state.liveScore === 100) app.logic.manualSave(true); 
                }
            },
            manualSave: async (isAutoMastery = false) => {
                if(state.userType !== 'student' || !state.currentGame) return;
                const gId = state.currentGame.gameId;
                const scoreData = state.currentUser.scores?.[gId];
                
                let ptsToAdd = 0;
                let awardedNow = false;
                if(state.liveScore === 100 && (!scoreData || !scoreData.lifetimePointsAwarded)) {
                    ptsToAdd = 10;
                    awardedNow = true;
                    ui.confetti();
                }

                const scoreObj = { 
                    score: state.liveScore, 
                    total: state.lastSessionData.total,
                    correct: state.lastSessionData.correct,
                    date: new Date().toISOString(), 
                    lifetimePointsAwarded: awardedNow || (scoreData?.lifetimePointsAwarded || false) 
                };
                const best = (scoreData?.score) || 0;

                await updateDoc(doc(db, "students", state.studentId), {
                    [`scores.${gId}`]: state.liveScore >= best ? scoreObj : scoreData,
                    pointsBalance: increment(ptsToAdd),
                    totalPointsEverEarned: increment(ptsToAdd),
                    status: `‚úÖ Last Score: ${state.liveScore}% (${state.currentGame.title})`
                });

                if(awardedNow) ui.toast("+10 Mastery Points Earned! üí∞");
                else if(!isAutoMastery) ui.toast("Progress Saved!");
            },
            exitGame: () => { if(state.userType === 'student') updateDoc(doc(db, "students", state.studentId), { status: "Idle", currentSessionScore: 0 }); router.go('library'); },
            publishGame: async () => {
                const title = document.getElementById('adm-title').value;
                const html = document.getElementById('adm-html').value;
                const subj = document.getElementById('adm-subj').value;
                const grade = document.getElementById('adm-grade').value;
                const topic = document.getElementById('adm-topic').value;
                const externalUrl = document.getElementById('adm-url').value; // NEW

                if(!title) return alert("Please enter a title!");
                
                ui.spinner(true);
                const id = state.editingGameId || 'g_' + Date.now();

                try {
                    await setDoc(doc(db, "games", id), { 
                        gameId: id, 
                        title, 
                        subject: subj, 
                        grade, 
                        topic, 
                        htmlCode: html,
                        externalUrl: externalUrl, // SAVING THE LINK
                        creatorId: state.currentUser.uid 
                    });
                    
                    ui.toast(state.editingGameId ? "Lesson Updated!" : "Lesson Published!");
                    state.editingGameId = null;
                    // Clear fields
                    document.getElementById('adm-title').value = '';
                    document.getElementById('adm-html').value = '';
                    document.getElementById('adm-url').value = ''; 
                    router.go('landing');
                } catch (e) {
                    alert("Error saving: " + e.message);
                }
                ui.spinner(false);
            },
            deleteGame: async (docId) => { if(confirm("Permanently delete?")) { await deleteDoc(doc(db, "games", docId)); logic.refreshContent(); } },
            refreshContent: () => { logic.selectSubject(state.selectedSubject); },
            renderShop: async () => {
                const snap = await getDocs(collection(db, "shop"));
                const grid = document.getElementById('student-shop-grid');
                if(!grid) return; grid.innerHTML = '';
                snap.forEach(d => {
                    grid.innerHTML += `<div class="card" style="text-align:center;"><h3>${d.data().name}</h3><p style="font-size:1.5rem; margin:10px 0;">üí∞ ${d.data().price}</p><button class="btn btn-primary" style="width:100%;" onclick="app.logic.buyItem('${d.id}', ${d.data().price}, '${d.data().name}')">Purchase</button></div>`;
                });
            },
            buyItem: async (id, pr, nm) => {
                if(state.currentUser.pointsBalance < pr) return alert("Not enough points!");
                const batch = writeBatch(db);
                batch.update(doc(db, "students", state.studentId), { pointsBalance: increment(-pr) });
                batch.add(collection(db, "redemptions"), { studentName: state.currentUser.name, itemName: nm, teacherId: state.currentUser.teacherId, status: 'pending', date: serverTimestamp() });
                await batch.commit(); ui.confetti(); ui.toast("Purchase successful! Teacher notified.");
            },
            showPurchaseHistory: async () => {
                const s = await getDocs(query(collection(db, "redemptions"), where("studentName", "==", state.currentUser.name)));
                const list = document.getElementById('stuff-list');
                list.innerHTML = s.docs.map(d => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${d.data().itemName}</b> <span style="float:right; font-size:0.7rem;">${d.data().status.toUpperCase()}</span></div>`).join('') || 'No purchases yet.';
                document.getElementById('modal-stuff').classList.remove('hidden');
            }
        };

        const dashboard = {
            // --- NEW UNASSIGN POWERS START ---
            manageStudentQuests: async (studentId, studentName) => {
                state.editingStudentId = studentId; 
                document.getElementById('manage-quest-name').textContent = `${studentName}'s Assignments`;
                const list = document.getElementById('active-assignments-list');
                list.innerHTML = 'Loading...';
                document.getElementById('modal-assignments').classList.remove('hidden');

                const sSnap = await getDocs(query(collection(db, "students"), where("__name__", "==", studentId)));
                const assignments = sSnap.docs[0].data().assignments || [];

                if(assignments.length === 0) {
                    list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">No active assignments.</p>';
                    return;
                }

                const gSnap = await getDocs(query(collection(db, "games"), where("gameId", "in", assignments)));
                const games = gSnap.docs.map(d => d.data());

                list.innerHTML = games.map(g => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div>
                            <div style="font-weight:800;">${g.title}</div>
                            <div style="font-size:0.7rem; color:#666;">${g.subject} ‚Ä¢ ${g.topic}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="app.dashboard.unassignGame('${g.gameId}')">Unassign ‚ùå</button>
                    </div>
                `).join('');
            },

            unassignGame: async (gameId) => {
                if(!confirm("Remove this quest from the student?")) return;
                ui.spinner(true);
                try {
                    await updateDoc(doc(db, "students", state.editingStudentId), { assignments: arrayRemove(gameId) });
                    ui.toast("Quest Unassigned!");
                    const sName = document.getElementById('manage-quest-name').textContent.split("'")[0];
                    app.dashboard.manageStudentQuests(state.editingStudentId, sName);
                } catch (e) { console.error(e); }
                ui.spinner(false);
            },

            bulkUnassign: async () => {
                const gameId = document.getElementById('assign-game').value;
                const studentIds = Array.from(document.querySelectorAll('.stu-assign-cb:checked')).map(c => c.value);
                if(!gameId || studentIds.length === 0) return alert("Select lesson and students first.");
                if(!confirm(`Remove this quest from ${studentIds.length} students?`)) return;

                ui.spinner(true);
                try {
                    const batch = writeBatch(db);
                    studentIds.forEach(sid => {
                        batch.update(doc(db, "students", sid), { assignments: arrayRemove(gameId) });
                    });
                    await batch.commit();
                    ui.toast(`Successfully removed from ${studentIds.length} students!`);
                } catch (e) { console.error(e); }
                ui.spinner(false);
            },
            // --- NEW UNASSIGN POWERS END ---
            
            init: () => dashboard.switchTab('monitor'),
            switchTab: (t) => {
                document.querySelectorAll('.dashboard-section').forEach(s => s.classList.add('hidden'));
                document.querySelectorAll('.v-tab').forEach(bt => bt.classList.remove('active'));
                const page = document.getElementById(`dash-${t}`);
                if(page) page.classList.remove('hidden');
                const btn = document.getElementById(`d-tab-${t}`);
                if(btn) btn.classList.add('active');
                
                 if(t === 'groups') app.dashboard.loadGroups();
                if(t === 'assign') app.dashboard.loadGroups(); // Refresh groups for the assign tab too
                if(t === 'monitor') dashboard.loadMonitor();
                if(t === 'class') dashboard.loadRoster();
                if(t === 'assign') { dashboard.loadAssignableGames(); dashboard.loadStudentsForAssignment(); }
                if(t === 'grades') dashboard.loadGrades();
                if(t === 'shop') dashboard.loadShopManager();
            },
            loadMonitor: () => {
                const filterGrade = document.getElementById('monitor-filter-grade').value;
                const stuckBody = document.getElementById('monitor-stuck-body'); 
                const trackBody = document.getElementById('monitor-track-body');

                // 1. Visual Feedback: Clear the tables so the teacher sees it "refreshing"
                stuckBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Refreshing...</td></tr>';
                trackBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Refreshing...</td></tr>';

                // 2. Kill the old listener if it exists to save battery/data
                if (window.activeMonitorListener) {
                    window.activeMonitorListener(); // This stops the old "pipeline"
                }

                // 3. Start the new "Live Pipeline"
                window.activeMonitorListener = onSnapshot(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)), (snap) => {
                    stuckBody.innerHTML = '';
                    trackBody.innerHTML = '';
                    
                    snap.forEach(d => {
                        const s = d.data();
                        
                        // Apply the Grade Filter
                        if (filterGrade !== "" && s.grade !== filterGrade) return; 

                        // Calculate Accuracy & Guessing
                        const total = s.currentSessionTotal || 0;
                        const correct = s.currentSessionCorrect || 0;
                        const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
                        const isGuessing = total > 5 && accuracy < 40;
                        const isStruggling = s.currentSessionScore > 0 && s.currentSessionScore < 50;
                        const isIdle = s.status === "Idle" || !s.status;

                        const rowHTML = `<tr>
                            <td style="font-weight:bold;">
                                ${s.name}
                                ${isGuessing ? '<div style="font-size:0.6rem; color:var(--danger); background:#fee2e2; padding:2px 4px; border-radius:4px; display:inline-block; margin-left:5px;">‚ö†Ô∏è GUESSING</div>' : ''}
                            </td>
                            <td style="font-size:0.75rem;">${s.status || 'Idle'}</td>
                            <td style="font-weight:800; color: ${isStruggling ? 'var(--danger)' : 'var(--secondary)'};">${s.currentSessionScore || 0}%</td>
                            <td>
                                <div style="font-size:0.8rem;">${accuracy}%</div>
                                <div style="font-size:0.6rem; color:#94a3b8;">(${correct}/${total})</div>
                            </td>
                        </tr>`;

                        if (isStruggling || isGuessing) {
                            stuckBody.innerHTML += rowHTML;
                        } else if (!isIdle) {
                            trackBody.innerHTML += rowHTML;
                        }
                    });

                    // Empty State Messages
                    if (stuckBody.innerHTML === '') stuckBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8; padding:20px;">No students struggling.</td></tr>';
                    if (trackBody.innerHTML === '') trackBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8; padding:20px;">No active students.</td></tr>';
                });
            },
            adjustPoints: async (id, amt) => {
                await updateDoc(doc(db, "students", id), { 
                    pointsBalance: increment(amt), 
                    totalPointsEverEarned: increment(amt > 0 ? amt : 0) 
                });
                ui.toast("Points adjusted!");
            },
            loadRoster: async () => {
    // 1. Get the filter value from our new dropdown
    const filterGrade = document.getElementById('roster-filter-grade').value;
    
    // 2. Fetch the students from the database
    const s = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
    const body = document.getElementById('student-list-body');
    
    // 3. Clear the list and rebuild it
    body.innerHTML = s.docs.map(d => {
        const data = d.data();
        
        // --- THE FILTER LOGIC ---
        // If a filter is selected, and it doesn't match this student's grade, skip them!
        if (filterGrade !== "" && data.grade !== filterGrade) {
            return ''; 
        }

        // Inside dashboard.loadRoster, update the return line:
return `<tr style="border-bottom:1px solid #eee;">
    <td style="padding:10px;"><b>${data.name}</b> (Gr ${data.grade})</td>
    <td><code>${data.loginCode}</code></td>
    <td>
        <button class="btn btn-primary btn-sm" onclick="app.dashboard.manageStudentQuests('${d.id}', '${data.name}')">üëÅÔ∏è Quests</button>
        <button class="btn btn-outline btn-sm" onclick="app.dashboard.toggleUserLock('${d.id}', ${data.gamesLocked})">${data.gamesLocked ? 'üîì Unlock' : 'üîí Lock'}</button>
        <button class="btn btn-danger btn-sm" onclick="app.dashboard.deleteStudent('${d.id}')">üóëÔ∏è</button>
    </td>
</tr>`;
    }).join('');
},
            toggleUserLock: async (id, curr) => {
                await updateDoc(doc(db, "students", id), { gamesLocked: !curr });
                dashboard.loadRoster();
            },
            bulkToggleLock: async (lockStatus) => {
    if(!confirm(`Are you sure you want to ${lockStatus ? 'LOCK' : 'UNLOCK'} game access for the ENTIRE class?`)) return;
    ui.spinner(true);
    try {
        const batch = writeBatch(db);
        const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
        
        snap.forEach((studentDoc) => {
            batch.update(doc(db, "students", studentDoc.id), { gamesLocked: lockStatus });
        });

        await batch.commit();
        ui.toast(`Classroom ${lockStatus ? 'Locked' : 'Unlocked'}!`);
        app.dashboard.loadRoster(); // Refresh the list to show the new icons
    } catch (error) {
        console.error("Bulk lock failed:", error);
        alert("Action failed. Check console.");
    }
    ui.spinner(false);
},
            deleteStudent: async (id) => {
                if(confirm("Delete this student permanently?")) {
                    await deleteDoc(doc(db, "students", id));
                    dashboard.loadRoster();
                }
            },
            loadAssignableGames: async () => {
                const subj = document.getElementById('assign-subject').value;
                const gradeF = document.getElementById('assign-grade-filter').value;
                const snap = await getDocs(query(collection(db, "games"), where("subject", "==", subj)));
                const select = document.getElementById('assign-game');
                let filtered = snap.docs.map(d => d.data());
                if(gradeF) filtered = filtered.filter(g => g.grade === gradeF);
                select.innerHTML = filtered.map(g => `<option value="${g.gameId}">[Gr ${g.grade}] ${g.title}</option>`).join('') || '<option value="">No games found</option>';
            },
            loadStudentsForAssignment: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                const list = document.getElementById('assign-student-list'); list.innerHTML = '';
                snap.forEach(d => {
                    list.innerHTML += `<label style="display:block; margin-bottom:8px; cursor:pointer;"><input type="checkbox" class="stu-assign-cb" value="${d.id}" checked> <b>${d.data().name}</b> (Grade ${d.data().grade})</label>`;
                });
            },
            toggleCheckboxes: (v) => document.querySelectorAll('.stu-assign-cb').forEach(c => c.checked = v),
            assignToSelected: async () => {
                const gId = document.getElementById('assign-game').value;
                const sIds = Array.from(document.querySelectorAll('.stu-assign-cb:checked')).map(c => c.value);
                if(!gId || sIds.length === 0) return alert("Select lesson and students");
                ui.spinner(true);
                await Promise.all(sIds.map(id => updateDoc(doc(db, "students", id), { assignments: arrayUnion(gId) })));
                ui.toast(`Successfully pushed lesson to ${sIds.length} students!`); ui.spinner(false);
            },
            loadGrades: async () => {
                const gSnap = await getDocs(collection(db, "games"));
                state.allGamesMap = {}; 
                gSnap.forEach(d => state.allGamesMap[d.data().gameId] = d.data());
                
                app.dashboard.updateGradebookLessonFilter();
                app.dashboard.renderGrades();
            },

            updateGradebookLessonFilter: () => {
                const gf = document.getElementById('gb-filter-grade').value;
                const sf = document.getElementById('gb-filter-subject').value;
                const select = document.getElementById('gb-filter-game');
                
                let html = '<option value="">All Lessons</option>';
                
                Object.values(state.allGamesMap).forEach(g => {
                    const matchesGrade = !gf || g.grade === gf;
                    const matchesSubject = !sf || g.subject === sf;
                    
                    if (matchesGrade && matchesSubject) {
                        html += `<option value="${g.gameId}">${g.title}</option>`;
                    }
                });
                
                select.innerHTML = html;
            },
            renderGrades: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                const body = document.getElementById('grade-body'); body.innerHTML = '';
                const gf = document.getElementById('gb-filter-grade').value, sf = document.getElementById('gb-filter-subject').value, gmf = document.getElementById('gb-filter-game').value;
                
                snap.forEach(d => {
                    const s = d.data(); if(gf && s.grade !== gf) return;
                    Object.keys(s.scores || {}).forEach(gid => {
                        const m = state.allGamesMap[gid]; if(!m) return;
                        if(sf && m.subject !== sf) return; if(gmf && gid !== gmf) return;
                        const sd = s.scores[gid];
                        body.innerHTML += `<tr><td>${s.name}</td><td>${m.title}</td><td style="font-weight:bold;">${sd.score}%</td><td>${sd.correct || 0} / ${sd.total || 0}</td><td>${new Date(sd.date).toLocaleDateString()}</td></tr>`;
                    });
                });
            },
            exportGrades: async () => {
                const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                let csv = "Student,Subject,Lesson,Score,Accuracy,Date\n";
                snap.forEach(d => {
                    const s = d.data();
                    Object.keys(s.scores || {}).forEach(gid => {
                        const m = state.allGamesMap[gid]; if(!m) return;
                        const sd = s.scores[gid];
                        csv += `"${s.name}","${m.subject}","${m.title}","${sd.score}%","${sd.correct}/${sd.total}","${sd.date}"\n`;
                    });
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', 'eduquest_grades.csv');
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },
            resetTopicScores: async () => {
    // 1. Identify which lesson we want to clear
    const gameId = document.getElementById('gb-filter-game').value;
    
    // 2. Safety Check: Make sure a lesson is actually selected
    if (!gameId) {
        alert("Please select a specific lesson from the dropdown first!");
        return;
    }

    // 3. The "Are you sure?" confirmation
    const lessonTitle = state.allGamesMap[gameId]?.title || "this topic";
    if (!confirm(`‚ö†Ô∏è PERMANENT ACTION: Are you sure you want to delete ALL student scores for "${lessonTitle}"? This cannot be undone.`)) {
        return;
    }

    ui.spinner(true); // Show the loading spinner

    try {
        // 4. Get all students for this teacher
        const snap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
        
        // 5. Create a "Batch" (This allows us to update many students at once safely)
        const batch = writeBatch(db);

        snap.forEach((studentDoc) => {
            const studentRef = doc(db, "students", studentDoc.id);
            // This command tells Firebase: "Go inside the 'scores' list and delete only this specific gameId"
            batch.update(studentRef, {
                [`scores.${gameId}`]: deleteField()
            });
        });

        // 6. Commit the changes to the database
        await batch.commit();
        
        ui.toast(`Scores for "${lessonTitle}" have been cleared!`);
        app.dashboard.renderGrades(); // Refresh the table to show it's empty
    } catch (error) {
        console.error("Reset failed:", error);
        alert("There was an error resetting scores. Check console.");
    }
    
    ui.spinner(false); // Hide the spinner
},
            importCSV: () => {
                const file = document.getElementById('roster-csv').files[0];
                if(!file) return alert("Select CSV file");
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const lines = e.target.result.split('\n').map(l => l.trim()).filter(l => l.length > 0 && l.toLowerCase() !== 'name');
                    const batch = writeBatch(db);
                    lines.forEach(line => {
                        const parts = line.split(',');
                        const name = parts[0], grade = parts[1]?.trim() || "1";
                        const code = name.split(' ')[0].toLowerCase() + '-' + Math.floor(100+Math.random()*899);
                        batch.set(doc(collection(db, "students")), { name, grade, loginCode: code, teacherId: state.currentUser.uid, scores: {}, assignments: [], pointsBalance: 0, totalPointsEverEarned: 0, gamesLocked: false, status: "Idle" });
                    });
                    await batch.commit(); dashboard.loadRoster(); ui.toast("Roster updated!");
                };
                reader.readAsText(file);
            },
            loadShopManager: async () => {
                const items = await getDocs(collection(db, "shop"));
                document.getElementById('admin-shop-list').innerHTML = items.docs.map(d => `<div style="display:flex; justify-content:space-between; margin-bottom:5px; background:#f8fafc; padding:8px; border-radius:8px;"><span>${d.data().name} (${d.data().price} pts)</span><button class="btn btn-danger btn-sm" onclick="app.dashboard.deleteShopItem('${d.id}')">üóëÔ∏è</button></div>`).join('');
                onSnapshot(query(collection(db, "redemptions"), where("teacherId", "==", state.currentUser.uid), where("status", "==", "pending")), (snap) => {
                    document.getElementById('redemption-list').innerHTML = snap.docs.map(d => `<div class="card" style="padding:10px;"><b>${d.data().studentName}</b> requested ${d.data().itemName} <button class="btn btn-primary btn-sm" onclick="app.dashboard.completeOrder('${d.id}')">Approve ‚úÖ</button></div>`).join('') || '<p>No pending requests.</p>';
                });
            },
            addShopItem: async () => {
                const name = document.getElementById('shop-name').value;
                const price = parseInt(document.getElementById('shop-price').value);
                if(!name || isNaN(price)) return;
                await addDoc(collection(db, "shop"), { name, price });
                document.getElementById('shop-name').value = ''; document.getElementById('shop-price').value = '';
                dashboard.loadShopManager();
            },
            deleteShopItem: async (id) => { if(confirm("Remove item?")) { await deleteDoc(doc(db, "shop", id)); dashboard.loadShopManager(); } },
            completeOrder: async (id) => { await updateDoc(doc(db, "redemptions", id), { status: 'filled' }); ui.toast("Reward Approved!"); },
            createStudent: async () => {
                const name = document.getElementById('new-student-name').value;
                const grade = document.getElementById('new-student-grade').value;
                if(!name) return;
                const code = name.split(' ')[0].toLowerCase() + '-' + Math.floor(100+Math.random()*899);
                await addDoc(collection(db, "students"), { name, grade, loginCode: code, teacherId: state.currentUser.uid, pointsBalance: 0, totalPointsEverEarned: 0, scores: {}, assignments: [], gamesLocked: false, status: "Idle" });
                dashboard.loadRoster(); document.getElementById('new-student-name').value = '';
            },
            createGroup: async () => {
                const name = document.getElementById('new-group-name').value;
                if(!name) return;
                await addDoc(collection(db, "groups"), { name, teacherId: state.currentUser.uid, studentIds: [] });
                document.getElementById('new-group-name').value = '';
                app.dashboard.loadGroups();
                ui.toast("Group Created!");
            },

            loadGroups: async () => {
                const gSnap = await getDocs(query(collection(db, "groups"), where("teacherId", "==", state.currentUser.uid)));
                const gSelect = document.getElementById('group-select-list');
                const gAssignSelect = document.getElementById('assign-group-select');
                const display = document.getElementById('group-display-area');

                // Fill the Dropdowns (Only if they are empty or resetting)
                const groupOptions = gSnap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('');
                gSelect.innerHTML = '<option value="">Select Group to Edit...</option>' + groupOptions;
                if(gAssignSelect) gAssignSelect.innerHTML = '<option value="">Choose Group...</option>' + groupOptions;

                // Draw the Visual Cards on the right
                const sSnap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                display.innerHTML = '';
                gSnap.forEach(gDoc => {
                    const g = gDoc.data();
                    const members = sSnap.docs.filter(s => g.studentIds.includes(s.id));
                    display.innerHTML += `
                        <div class="card" style="margin:0; border-left: 4px solid var(--primary);">
                            <div style="display:flex; justify-content:space-between;"><strong>${g.name}</strong><button class="btn btn-danger btn-sm" style="padding:2px 5px;" onclick="app.dashboard.deleteGroup('${gDoc.id}')">üóëÔ∏è</button></div>
                            <div style="font-size:0.8rem; margin-top:10px; color:var(--text-light);">${members.map(m => m.data().name).join(', ') || 'No members'}</div>
                        </div>`;
                });
            },

            renderGroupChecklist: async () => {
                const gid = document.getElementById('group-select-list').value;
                const checkboxArea = document.getElementById('group-checkbox-container');
                
                if (!gid) {
                    checkboxArea.innerHTML = '<p style="font-size: 0.75rem; color: #666;">Select a group above to see students...</p>';
                    return;
                }

                ui.spinner(true);
                // Get the specific group and all students
                const gDoc = await getDocs(query(collection(db, "groups"), where("__name__", "==", gid)));
                const sSnap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                
                if (!gDoc.empty) {
                    const currentGroup = gDoc.docs[0].data();
                    checkboxArea.innerHTML = sSnap.docs.map(sDoc => {
                        const s = sDoc.data();
                        const isChecked = currentGroup.studentIds.includes(sDoc.id) ? 'checked' : '';
                        return `<label style="display:block; margin-bottom:8px; cursor:pointer; font-size:0.9rem;">
                            <input type="checkbox" class="group-stu-cb" value="${sDoc.id}" ${isChecked}> ${s.name} (Grade ${s.grade})
                        </label>`;
                    }).join('');
                }
                ui.spinner(false);
            },

            saveGroupBatch: async () => {
                const gid = document.getElementById('group-select-list').value;
                if(!gid) return alert("Please select a group first!");

                const checkedCheckboxes = document.querySelectorAll('.group-stu-cb:checked');
                const selectedIds = Array.from(checkedCheckboxes).map(cb => cb.value);

                ui.spinner(true);
                try {
                    await updateDoc(doc(db, "groups", gid), { studentIds: selectedIds });
                    ui.toast("Group members updated! ‚úÖ");
                    // Refresh the visual cards but DON'T reset the dropdown
                    const sSnap = await getDocs(query(collection(db, "students"), where("teacherId", "==", state.currentUser.uid)));
                    const gSnap = await getDocs(query(collection(db, "groups"), where("teacherId", "==", state.currentUser.uid)));
                    const display = document.getElementById('group-display-area');
                    display.innerHTML = '';
                    gSnap.forEach(gDoc => {
                        const g = gDoc.data();
                        const members = sSnap.docs.filter(s => g.studentIds.includes(s.id));
                        display.innerHTML += `
                            <div class="card" style="margin:0; border-left: 4px solid var(--primary);">
                                <div style="display:flex; justify-content:space-between;"><strong>${g.name}</strong><button class="btn btn-danger btn-sm" style="padding:2px 5px;" onclick="app.dashboard.deleteGroup('${gDoc.id}')">üóëÔ∏è</button></div>
                                <div style="font-size:0.8rem; margin-top:10px; color:var(--text-light);">${members.map(m => m.data().name).join(', ') || 'No members'}</div>
                            </div>`;
                    });
                } catch (e) {
                    console.error(e);
                    alert("Error saving group.");
                }
                ui.spinner(false);
            },

            deleteGroup: async (id) => {
                if(confirm("Delete group?")) { await deleteDoc(doc(db, "groups", id)); app.dashboard.loadGroups(); }
            },

            assignToGroup: async () => {
                const gId = document.getElementById('assign-group-select').value;
                const lessonId = document.getElementById('assign-game').value;
                if(!gId || !lessonId) return alert("Select group and lesson!");
                ui.spinner(true);
                const gDocRef = doc(db, "groups", gId);
                const gSnap = await getDocs(query(collection(db, "groups"), where("__name__", "==", gId)));
                const studentIds = gSnap.docs[0].data().studentIds;
                const batch = writeBatch(db);
                studentIds.forEach(sid => { batch.update(doc(db, "students", sid), { assignments: arrayUnion(lessonId) }); });
                await batch.commit();
                ui.spinner(false);
                ui.toast("Group assignment complete!");
            },
            
            // --- ADD THIS INSIDE THE app.dashboard OBJECT ---

bulkUnassign: async () => {
    const gameId = document.getElementById('assign-game').value;
    const studentIds = Array.from(document.querySelectorAll('.stu-assign-cb:checked')).map(c => c.value);

    if(!gameId) return alert("Please select a lesson first.");
    if(studentIds.length === 0) return alert("Please select at least one student.");

    if(!confirm(`Are you sure you want to REMOVE this quest from ${studentIds.length} students? (This will not delete their scores, only hide the quest from their list)`)) return;

    ui.spinner(true);
    try {
        const batch = writeBatch(db);
        
        studentIds.forEach(sid => {
            const sRef = doc(db, "students", sid);
            batch.update(sRef, {
                assignments: arrayRemove(gameId)
            });
        });

        await batch.commit();
        ui.toast(`Successfully removed from ${studentIds.length} students!`);
    } catch (e) {
        console.error(e);
        alert("Batch unassign failed. Check console.");
    }
    ui.spinner(false);
}
            
        };

        const authService = {
            loginTeacher: async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); router.go('landing'); } catch(e) { alert(e.message); } },
            loginStudent: async () => {
                const code = document.getElementById('student-login-code').value.trim();
                const snap = await getDocs(query(collection(db, "students"), where("loginCode", "==", code)));
                if(snap.empty) return alert("Invalid Access Code");
                const d = snap.docs[0];
                state.userType = 'student'; state.currentUser = d.data(); state.studentId = d.id;
                localStorage.setItem('edu_student_id', d.id);
                router.go('landing');
            },
            logout: async () => { if(state.userType === 'teacher') await signOut(auth); state.userType = null; state.currentUser = null; localStorage.removeItem('edu_student_id'); router.go('landing'); },
            check: () => {
                onAuthStateChanged(auth, (user) => {
    if(user) { 
        state.userType = 'teacher'; 
        state.currentUser = user; 
        // This line now shows the button for ANY logged-in teacher
        document.getElementById('admin-entry').classList.remove('hidden'); 
    }
    updateHeader();
});
                const sid = localStorage.getItem('edu_student_id');
                if(sid) onSnapshot(doc(db, "students", sid), (d) => { if(d.exists()){ state.userType = 'student'; state.currentUser = d.data(); state.studentId = d.id; updateHeader(); } });
            }
        };

        function updateHeader() {
            const h = document.getElementById('header-controls'); if(!h) return;
            if(!state.userType || !state.currentUser) {
                h.innerHTML = `<button class="btn btn-outline btn-sm" onclick="app.router.go('teacher-login')">Teacher Portal</button> <button class="btn btn-primary btn-sm" onclick="app.router.go('student-login')">Student Entrance</button>`;
            } else {
                if(state.userType === 'student') {
                    const rank = ui.getRank(state.currentUser.totalPointsEverEarned || 0);
                    document.getElementById('welcome-text').textContent = `Hi, ${state.currentUser.name}! üëã`;
                    
                    // This version includes the new ‚öîÔ∏è My Quests button
                    h.innerHTML = `
                        <button class="btn btn-primary btn-sm" onclick="app.logic.renderProfile(); app.router.go('profile')">‚öîÔ∏è My Quests</button>
                        <button class="btn btn-outline btn-sm" onclick="app.router.go('shop')">üõí Shop</button> 
                        <div class="wallet-display">üí∞ ${state.currentUser.pointsBalance || 0} <span class="rank-badge" style="background:${rank.color}">${rank.label}</span></div> 
                        <button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>
                    `;
                } else {
                    // This keeps the Teacher's Dashboard button working!
                    h.innerHTML = `<button class="btn btn-primary btn-sm" onclick="app.router.go('dashboard')">Dashboard</button> <button class="btn btn-outline btn-sm" onclick="app.auth.logout()">Sign Out</button>`;
                }
            }
        }

        window.addEventListener('message', (e) => { if(e.data?.type === 'TOOL_SCORE') logic.handleScoreUpdate(e.data); });
        ui.initDynamicUI();
        authService.check();
        window.app = { router, logic, auth: authService, dashboard };
        
// --- THE GUIDING BLUEPRINT (Your Full Principles Text) ---
const GUIDING_BLUEPRINT = `
When creating each assessment item, you must adhere to the following three principles:
1. STRUCTURE:
   - Item Type: Ensure the item matches format (Multiple-Choice, EBSR, Multi-Select, etc.).
   - Stimulus: All questions must be directly tied to the provided source text(s).
   - Stem: Clear, direct, and grade-appropriate language.
   - Options: Concise and parallel in structure.
2. CONSTRUCTION:
   - Clarity: Language must be precise and unambiguous.
   - Alignment: Tightly align with ELA standards and assessment limits.
   - Quality of Distractors: Incorrect options must be plausible, representing common misconceptions. Not obviously wrong or silly.
   - Evidence-Based: All correct answers must be directly supported by evidence within the source text.
3. RIGOR (COGNITIVE COMPLEXITY):
   - DOK 1 (Identify/Recall): Recalling facts, definitions, or locating info stated in text.
   - DOK 2 (Infer/Conclude): Applying skills, making inferences, or identifying cause-and-effect.
   - DOK 3 (Analyze/Evaluate): Strategic thinking, analyzing complex themes, or justifying claims with evidence.
   
   Implement a 'Just-in-Time' Learning System. Add a prominent "Hint" button to the game header. When clicked, trigger a modal popup that displays an Expert Curriculum Overview specific to the current active 'Day' (e.g., if on Day 1, show Day 1 concepts). MANDATORY ACCESSIBILITY: Inside the hint modal, include a "Read Aloud" button (speaker icon) that uses the browser's native, offline window.speechSynthesis API to narrate the lesson text for the student. Ensure the audio stops automatically when the modal is closed.`; 
 
        
        
        // --- PROMPT FORGE LOGIC ---
// --- THE 100% COMPLETE MASTER PROMPT DATA (AUDITED) ---
const FORGE_DATA = {
    category: null,
    builders: {
        ela_gen: { 
            name: "ELA General Tools Builder", 
            fields: ["Grade", "Topic/Standards", "Theme", "Style", "Count"], 
            template: `Act as a Senior Educational Game Developer and ELA Specialist. I need a complete, interactive educational game in a single HTML file to embed in my EduQuest platform.
Lesson Details:
Grade Level: [[Grade]]
Topic/Standards: [[Topic/Standards]]
Theme: [[Theme]]
Interaction Style: [[Style]]
Number of Questions: [[Count]]

### ELA COMPUTATIONAL THINKING INTEGRATION (MANDATORY)
Analyze the ELA Topic and Grade Level provided. Select one primary Computational Thinking skill that most naturally aligns with the logic of the lesson. Use this skill consistently to anchor the game's mechanics:
- Decomposition: Breaking complex words into parts (syllables, roots/suffixes) or sentences into specific parts of speech. (Student definition: "Breaking big words or sentences into smaller, easier pieces.")
- Pattern Recognition: Identifying recurring rules in spelling, rhyming, or how stories are built. (Student definition: "Finding patterns in how we spell and read.")
- Abstraction: Focusing on essential ideas (like the Main Idea) while ignoring irrelevant details. (Student definition: "Finding the most important part and ignoring the small details.")
- Algorithmic Thinking: Following step-by-step logic to apply rules for grammar, punctuation, or capitalization. (Student definition: "Following a set of rules to write perfectly.")

Execution Requirements:
- UI Badge: Display a prominent, bold UI badge in the header: "Skill: [Chosen Skill]".
- Thinking Wrapper: Below the badge, include the student-friendly definition provided above.
- Logic: Ensure the game mechanics reflect the chosen skill.
- Critical Technical Requirements: Single File, Responsive (75vh iframe), No Internal Save Button.
- The "Gradebook Connection" Logic (CRUCIAL):
Variables: Track currentScore (0-100), totalQuestions, and correctAnswers.
Immediate Trigger: Every time the student answers a question, you must run this code:
window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round((correctAnswers / totalQuestions) * 100), total: totalQuestions, correct: correctAnswers }, '*');

${GUIDING_BLUEPRINT}

Guiding Blueprint for Item Creation:
- Structure: Stimulus tied to text, Clear stems, Parallel options.
- Construction: Precise language, Alignment to standards, Quality distractors.
- Rigor (DOK): DOK 1 (Recall), DOK 2 (Infer), DOK 3 (Analyze).` 
        },
        
        math_gen: { 
            name: "Mathematics General Tools Builder", 
            fields: ["Grade", "Topic/Standards", "Theme", "Style", "Count"], 
            template: `Act as a Senior Educational Game Developer. I need a complete, interactive educational game in a single HTML file.
Lesson Details:
Grade Level: [[Grade]] | Topic/Standards: [[Topic/Standards]] | Theme: [[Theme]] | Interaction: [[Style]] | Questions: [[Count]]

### COMPUTATIONAL THINKING INTEGRATION (MANDATORY)
Select primary CT skill (Decomposition, Pattern Recognition, Abstraction, or Algorithmic Thinking).
- State chosen skill in a large UI badge.
- One-sentence Student-Friendly Definition explaining the "Why".
- The game's mechanics must reflect this skill (e.g., typing into three separate place-value boxes).

Technical Requirements:
- Resume Logic: Check window.INITIAL_SCORE.
- Handshake: Every time a student answers (even if wrong), run:
window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round((correctAnswers / totalQuestions) * 100), total: totalQuestions, correct: correctAnswers }, '*');

${GUIDING_BLUEPRINT}

Visual Style: "EdTech" design: Large buttons, Nunito/Arial, Blue (#0077cc), Green (#28a745).
Rigor: Item Type adherence, Stimulus alignment, DOK 1-3 progression.`
        },

        ela_pdf: { 
            name: "ELA Tools from PDF", 
            fields: ["Grade", "Theme", "PDF_Content"], 
            template: `Act as a Senior Learning Experience (LX) Designer and Full-Stack Developer.
Goal: Transform the attached PDF Curriculum into a high-engagement ELA interactive game.
PDF CONTENT: [[PDF_Content]]

STEP 1: CURRICULUM ANALYSIS (Internal Monologue)
- Analyze objective, extract exact words/sentences, identify scaffolding.
STEP 2: CT INTEGRATION (MANDATORY)
- Anchor to one: Decomposition, Pattern Recognition, Abstraction, or Algorithmic Thinking.
- Display UI Badge and student-friendly definition.
STEP 3: TECHNICAL ARCHITECTURE
- Handshake: window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round((correctAnswers / totalQuestions) * 100), total: totalQuestions, correct: correctAnswers }, '*');
- Responsive for 75vh iframe.
STEP 4: VISUAL STYLE
- "EdTech Pro" ‚Äì Blue (#0077cc), Green (#28a745). 50 questions based on PDF.`
        },

        math_pdf: { 
            name: "Mathematics Tools from PDF", 
            fields: ["Grade", "Theme", "PDF_Content"], 
            template: `Act as a Senior Learning Experience (LX) Designer and Expert Full-Stack Developer.
Goal: Transform the attached PDF curriculum into a "Math Lab Tool".
PDF CONTENT: [[PDF_Content]]

STEP 1: PEDAGOGICAL ANALYSIS (Internal Monologue)
- Identify visual models, progression, and trick questions.
STEP 2: GAMEPLAY & CT STRATEGY
- Design "Math Lab" mechanics.
- EXPLICIT INTEGRATION: Include a "Thinking Badge" that updates based on current logic (Decomposition help, Algorithmic checklists, Pattern Recognition streaks, Abstraction level-ups).
STEP 3: TECHNICAL
- PERSISTENCE: initialization must check window.INITIAL_SCORE and resume.
- REAL-TIME SYNC: window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round((correctAnswers / 50) * 100) }, '*');
- Visual Style: "Robot Repair" aesthetic: Deep blues, neon greens.`
        },

        all_subjects: {
            name: "All Subjects Tool Builder",
            fields: ["Grade", "Topic/Standards", "Count"],
            template: `Act as a Senior Learning Experience (LX) Designer, Curriculum Specialist, and Full-Stack Developer.
Design and build a complete, student-ready interactive learning game aligned to academic standards.
Grade Level: [[Grade]] | Topic/Standards: [[Topic/Standards]] | Count: [[Count]]

STEP 1: CONTENT SOURCE AUDIT (MANDATORY)
Determine the instructional source of truth before designing interactions.
Case A ‚Äì Provided Resource:
Analyze the supplied text/media/data. Extract:
Core concepts
Academic vocabulary
Skill demands (e.g., analyze, compute, interpret, argue)
Common misconceptions

Case B ‚Äì Generated Content:
Generate original, subject-appropriate content aligned to the grade level and standards.
Content type adapts to subject:
ELA: short texts, excerpts, narrative scenarios
Math: problems, models, real-world contexts
Science: phenomena, investigations, data sets
Social Studies: sources, timelines, decision scenarios
Arts / Other: critique tasks, creation challenges

Generate [Count] distinct items with increasing cognitive demand.

Content must be instructionally authentic, culturally neutral, and free of filler or trivia.

STEP 2: THINKING SKILL INTEGRATION (REQUIRED)
Select one cognitive anchor and design all gameplay around it.
Cognitive Anchor (choose one):
Decomposition, Pattern Recognition, Abstractionc, Algorithmic Thinking

Implementation Rules:
Explicitly map the anchor to the subject skill (e.g., abstraction ‚Üí modeling, theme, synthesis).
Embed the thinking skill into player actions, not just instructions.
Include a student-friendly explanation that:
Uses age-appropriate language
Explains how the skill helps learning in this subject
Appears in the UI (intro, help modal, or tooltip)

STEP 3: GAME DESIGN REQUIREMENTS
Interaction must be active (decision-making, manipulation, creation, or testing).
Use progressive difficulty or adaptive feedback.
Provide immediate, meaningful feedback for correct and incorrect responses.
Avoid multiple-choice-only designs unless pedagogically justified.
End with a clear ‚Äúlearning achieved‚Äù state.
STEP 4: TECHNICAL
- Persistence: Check window.INITIAL_SCORE.
- Handshake: window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round((correctAnswers / totalQuestions) * 100), total: totalQuestions, correct: correctAnswers }, '*');`

        },

        assessment: { 
            name: "Assessment Builder", 
            fields: ["Grade", "Topic", "Count", "Source_Text"], 
            template: `### Act as a Senior Full-Stack Developer and SC ELA Curriculum Expert. Your goal is to generate a single-file, fully functional HTML/CSS/JS website that acts as a standalone assessment for students.
Input: Grade [[Grade]], Topic/Standards [[Topic/Standards]], Count [[Count]]. Stimulus: [[Source_Text]].

${GUIDING_BLUEPRINT}

PHASE 1: CONTENT GENERATION
- Align to Standard/Topic. 
- If a {{SourceDocument}} is provided, use it as the primary stimulus.
If not, generate a high-quality, grade-appropriate stimulus aligned to Grade {{GradeLevel}} and {{Topic/Standards}}.
The stimulus should be appropriate to the subject area and may include one or more of the following as relevant:
Narrative or informational text
Data tables, graphs, charts, or diagrams
Real-world scenarios or problem contexts
Historical sources or scientific descriptions
Ensure the stimulus supports assessment of key skills and standards for the subject.
-Create stimulus if missing.
-ITEMS: Create {{Count}} multiple-choice questions with 4 options each. Include an "Evidence-Based" rationale for the correct answer.
PHASE 2: UI/UX ARCHITECTURE
- Split-Pane layout (Stimulus left, Items right). Montserrat/Open Sans fonts.
PHASE 3: TECHNICAL
- logic to postMessage TOOL_SCORE on every selection. 
- Blueprint Principles: Adhere to Structure, Construction, and Rigor (DOK 1-3).
- Guiding Instructions: Strictly follow evidence statements and assessment limits. 
- Distribute across formats: EBSR, Multi-Select, Constructed-Response, Technology-Enhanced (Drag/Drop).

### 1.2 Define Skill-Mastery Practice Center
- Content: At least 20 distinct activities.
- Interaction: "Check Answer" button logic (Lock answer if correct, show "Try Again" if incorrect).
- Victory Delay: 3-second delay on final submission.` 
        },

        game_builder: { 
            name: "Game Tools Builder", 
            fields: ["Grade", "Topic/Standards", "Theme", "Loop"], 
            template: `ROLE: Master Educator, AAA Narrative Designer, Senior Developer.
Grade: [[Grade]], Topic/Standards: [[Topic/Standards]], Theme: [[Theme]], Loop: [[Loop]]

Phase 1: Game Design Document (The Creative Blueprint)
- Game Title, The Legend (Narrative), The Quest (Goal), Mechanics.
- SVG Visual Toolkit Definition (Machine-readable descriptions).
Phase 2: Game Specification File (The Technical Blueprint)
- Explicit JSON Schema for stages, questions, assets.
Phase 3: Build Interactive Game
- Vanilla JS/HTML5/CSS3. Inline SVG.
- Logic driven by parsing Phase 2 JSON.
- Handshake: TOOL_SCORE postMessage on every answer.` 
        },

        multi_activity: { 
            name: "Multi-Activity Builder", 
            fields: ["Grade", "Topic", "Activity_Count"], 
            template: `Build a Multi-Activity tool for [[Topic]], Grade [[Grade]].
Activity Count: [[Activity_Count]]

Act as a Senior Curriculum Expert, Learning Experience (LX) Designer, and Full-Stack Developer. Your goal is to design and build a complete, standards-aligned ELA interactive learning experience in a single self-contained HTML file. You are responsible for determining the optimal number, sequence, and type of activities needed to move learners from initial exposure to mastery of the provided {{Topic}} or {{Standards}}.

Instructional Design Expectations
Design a multi-activity learning sequence that is:
Intentionally scaffolded
Developmentally appropriate for Grade {{GradeLevel}}
Aligned to the cognitive demands of the standards
Determine the most effective progression of activities, which may include:
Modeling or guided exploration
Supported practice
Application in new contexts
Independent or transfer tasks
Scaffolding should be evident through:
Gradual release of responsibility
Increasing complexity and rigor
Reduction of hints and supports over time
Mastery-Based Learning
Define clear mastery criteria for each activity
Require learners to demonstrate mastery before advancing
Provide immediate, actionable feedback
Allow retries, adaptive hints, or alternate pathways when mastery is not met

Activity Design
Use a variety of interaction types appropriate to ELA (e.g., text analysis, evidence selection, sequencing, short responses, game mechanics)
Ensure each activity targets a specific skill or sub-skill that contributes to overall mastery
Standards & Transparency

Explicitly align each activity to:
One or more of the provided {{Standards}}
A clearly stated learning objective
Embed teacher-facing metadata as comments in the HTML explaining:
Instructional purpose of each activity

How scaffolding is applied
Mastery criteria
Technical Requirements
Output a single HTML file with embedded CSS and JavaScript
No external libraries or dependencies

Include clear learner instructions, progress indicators, and feedback mechanisms

1. MULTI-ACTIVITY RESUME HANDSHAKE:
- Define daySmartScores = [0,0,0,0,0].
- Logic to distribute window.INITIAL_SCORE so student starts on the correct day.
2. ADAPTIVE SMART SCORE: 
- Correct: <70 +5, <90 +5, else +2. Incorrect: -5.
3. COMPOSITE BROADCAST: 
- Average all activity scores into one master score (0-100).
- window.parent.postMessage({ type: 'TOOL_SCORE', score: Number(masterScore), total: 100, correct: masterScore }, '*');
4. VICTORY DELAY: Show "Full Module Mastered!" for 2.5s at 100%.` 
        }
    },
    checkers: {
        smart: `### SMART SCORE CHECKER (PATCH)
1. Define let smartScore;
2. init(): if (typeof window.INITIAL_SCORE !== 'undefined') { smartScore = window.INITIAL_SCORE; } else { smartScore = 0; }
3. Update: totalQuestions++; if (isCorrect) { if (smartScore < 70) smartScore += 5; else smartScore += 2; } else { smartScore -= 5; }
4. Sync: window.parent.postMessage({ type: 'TOOL_SCORE', score: Math.round(smartScore), total: totalQuestions, correct: correctAnswers }, '*');
5. Victory Delay: 2 seconds at 100% score.`,
        
        assessment: `### ASSESSMENT CHECKER (PATCH)
1. recordGrade(): currentGrade = Math.round((correctAnswers / totalQuestions) * 100).
2. Sync: window.parent.postMessage({ type: 'TOOL_SCORE', score: Number(currentGrade), total: totalQuestions, correct: correctAnswers }, '*');
3. Data Integrity: All values must be Integers (Math.round).
4. Victory Delay: 3-second delay on final submit.`,
        
        multi: `### MULTI-ACTIVITY CHECKER (PATCH)
1. loadSavedProgress(): Distribute window.INITIAL_SCORE across daySmartScores array.
2. broadcastMasterProgress(): masterScore = Math.round(sum / daySmartScores.length).
3. Sync: window.parent.postMessage({ type: 'TOOL_SCORE', score: masterScore, total: 100, correct: masterScore }, '*');
4. Victory Delay: 2.5 seconds at 100% score.`
    }
};

app.forge = {
    selectCategory: (cat) => {
        FORGE_DATA.category = cat;
        // Filter builders: if they chose assessment, only show assessment builders, etc.
        const sel = document.getElementById('forge-builder-select');
        sel.innerHTML = Object.keys(FORGE_DATA.builders).map(k => `<option value="${k}">${FORGE_DATA.builders[k].name}</option>`).join('');
        app.forge.renderInputs();
        app.forge.goToStep(2);
    },
    renderInputs: () => {
        const bKey = document.getElementById('forge-builder-select').value;
        const fields = FORGE_DATA.builders[bKey].fields;
        const area = document.getElementById('forge-inputs-area');
        area.innerHTML = fields.map(f => `
            <div style="margin-top:10px;">
                <label style="font-size:0.7rem;">${f}</label>
                ${f.includes('Content') || f.includes('Text') || f === 'Loop' ? 
                  `<textarea id="inp-${f}" class="input" style="height:60px;"></textarea>` : 
                  `<input type="text" id="inp-${f}" class="input">`}
            </div>
        `).join('');
    },
    generateAndGo: () => {
        const bKey = document.getElementById('forge-builder-select').value;
        const builder = FORGE_DATA.builders[bKey];
        let prompt = builder.template;
        
        builder.fields.forEach(f => {
            const val = document.getElementById(`inp-${f}`).value || `[${f}]`;
            prompt = prompt.replace(`[[${f}]]`, val);
        });

        if(document.getElementById('forge-check-readaloud').checked) {
            prompt += "\n\nREQUIREMENT: Include Read Aloud icons (üîä) for all questions and options using Web Speech API.";
        }

        document.getElementById('master-prompt-box').textContent = prompt;
        document.getElementById('checker-prompt-box').textContent = FORGE_DATA.checkers[FORGE_DATA.category];
        app.forge.goToStep(3);
    },
    goToStep: (stepNum) => {
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`forge-step-${stepNum}`).classList.add('active');
    },
    copy: (id) => {
        const text = document.getElementById(id).textContent;
        navigator.clipboard.writeText(text);
        ui.toast("Copied to clipboard!");
    }
};

// Add to the switchTab function
const oldSwitchTab = app.dashboard.switchTab;
app.dashboard.switchTab = (t) => {
    oldSwitchTab(t);
    if(t === 'forge') app.forge.goToStep(1); 
};
    </script>
</body>
</html>
